@model ProjectManagementSystem.ViewModels.ProjectIdeasViewModel
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Student Projects";
    Layout = "~/Views/Shared/_PublicLayout.cshtml";
}

<style>   
    .project-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        border-radius: 0.5rem;
        background-color: #e4eefd; /* soft blue */
        border: 1px solid #8c5dd1; /* purple */
        box-shadow: 0 0.125rem 0.25rem rgb(0 0 0 / 0.07);
    }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(140, 93, 209, 0.3);
            z-index: 5;
        }

    .file-list li {
        list-style: none;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    .file-icon {
        font-size: 1.1rem;
        color: #8c5dd1;
        flex-shrink: 0;
    }

    .pagination .page-item.active .page-link {
        background-color: #8c5dd1;
        border-color: #8c5dd1;
        color: #fff;
    }

    .pagination .page-link:hover {
        background-color: #c8c6c1;
        color: #212529;
    }

    .filter-select {
        max-width: 320px;
        border-color: #8c5dd1;
        color: #8c5dd1;
    }

        .filter-select:focus {
            border-color: #8c5dd1;
            box-shadow: 0 0 0 0.2rem rgba(140, 93, 209, 0.25);
        }

    .header-flex {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .small-dashboard-card {
        display: inline-flex;
        align-items: center;
        background: #c8c6c1;
        border-radius: 0.375rem;
        padding: 0.3rem 0.7rem;
        box-shadow: 0 0.125rem 0.25rem rgb(0 0 0 / 0.1);
        min-width: 140px;
        user-select: none;
        gap: 0.5rem;
        font-weight: 600;
        color: #4b0082;
        cursor: default;
    }

    .small-dashboard-icon {
        font-size: 1.4rem;
        opacity: 0.8;
        color: #8c5dd1;
        flex-shrink: 0;
    }

    .card-title {
        font-size: 1.25rem;
        color: #8c5dd1;
    }

    .card-subtitle {
        font-size: 0.9rem;
        color: #6b46c1;
    }

    .card-text {
        font-size: 0.95rem;
        color: #1e293b;
    }

    .badge.bg-info {
        background-color: #d5cfff !important;
        color: #5a3fa3 !important;
        font-weight: 600;
    }

    /* Search suggestion dropdown */
    #searchSuggestions {
        background-color: white;
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
        border-top: none;
        position: absolute;
        z-index: 1050;
        width: 100%;
    }
     ul.pagination {
            display: flex;
            flex-wrap: wrap;
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }

            ul.pagination li {
                margin: 3px;
            }

                ul.pagination li a,
                ul.pagination li span {
                    display: block;
                    padding: 0.375rem 0.75rem;
                    color: #8c5dd1;
                    text-decoration: none;
                    border: 1px solid #8c5dd1;
                    border-radius: 0.25rem;
                    transition: background-color 0.2s, color 0.2s;
                }

                    ul.pagination li a:hover:not(.disabled) {
                        background-color: #8c5dd1;
                        color: white;
                        border-color: #8c5dd1;
                    }

                ul.pagination li.active span {
                    background-color: #8c5dd1;
                    color: white;
                    border-color: #8c5dd1;
                }

                ul.pagination li.disabled span {
                    color: #6c757d;
                    border-color: #dee2e6;
                }
</style>

<div class="header-flex">
    <h2 class="mb-0">@ViewData["Title"]</h2>

    <div class="small-dashboard-card" title="Total Projects">
        <i class="bi bi-journal-code small-dashboard-icon"></i>
        <span>Total Projects: @Model.TotalProjects</span>
    </div> 
</div>

<form method="get" asp-action="ProjectIdeas" id="filterForm" class="mb-4" autocomplete="off">
    <div class="row g-2 align-items-center position-relative">
        <div class="col-auto">
            <select id="projectTypeDropdown" name="projectTypeId" class="form-select filter-select" onchange="loadLanguages()">
                <option value="">-- Filter by Project Type --</option>
                @foreach (var type in Model.ProjectTypes)
                {
                    var isSelected = type.Value == Model.SelectedProjectTypeId?.ToString();
                    <option value="@type.Value" selected="@(isSelected ? "selected" : null)">@type.Text</option>
                }
            </select>
        </div>

        <div class="col-auto">
            <select id="languageDropdown" name="languageId" class="form-select filter-select" onchange="submitFilterForm()">
                <option value="">-- Filter by Language --</option>
                @foreach (var type in Model.Languages)
                {
                    var isSelected = type.Value == Model.SelectedLanguageId?.ToString();
                    <option value="@type.Value" selected="@(isSelected ? "selected" : null)">@type.Text</option>
                }
            </select>
        </div>

        <div class="col-auto position-relative" style="min-width: 250px;">
            <input type="text" id="searchInput" name="searchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Search projects..." />
            <div id="searchSuggestions" class="list-group"></div>
        </div>

        <div class="col-auto">
            <button class="btn btn-outline-primary" type="submit">
                <i class="bi bi-search"></i>
            </button>
        </div>

        @if (Model.SelectedProjectTypeId.HasValue || Model.SelectedLanguageId.HasValue || !string.IsNullOrWhiteSpace(Model.SearchTerm))
        {
            <div class="col-auto">
                <a asp-action="ProjectIdeas" class="btn btn-outline-secondary">
                    ← Back to All Projects
                </a>
            </div>
        }
    </div>
</form>

@if (!Model.Projects.Any())
{
    <p class="text-muted fst-italic fs-5">No projects found for the selected filters.</p>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        @foreach (var project in Model.Projects)
        {
            <div class="col">
                <div class="card project-card h-100 border-primary shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title fw-bold">@project.ProjectName</h5>
                        <h6 class="card-subtitle mb-2">Supervisor: @project.SupervisorName</h6>
                        <p class="card-text mb-2">
                            <span class="badge bg-info text-dark">Type: @project.ProjectTypePk?.TypeName</span>
                        </p>
                        <p class="card-text mb-2">
                            <span class="badge bg-info text-dark">Type: @project.LanguagePk.LanguageName</span>
                        </p>
                        @* <p class="card-text flex-grow-1 text-truncate" style="max-height: 4.5rem; overflow: hidden;">
                            Description: @project.Description
                        </p> *@

                        @if (project.ProjectFiles != null && project.ProjectFiles.Any())
                        {
                            <div class="mt-3">
                                <strong>Files:</strong>
                                <ul class="file-list ps-0 mt-1">
                                    @foreach (var file in project.ProjectFiles)
                                    {
                                        <li>
                                            <i class="bi bi-file-earmark-text file-icon"></i>
                                            <a href="@file.FilePath" target="_blank" class="text-decoration-none">
                                                @System.IO.Path.GetFileName(file.FilePath)
                                            </a>
                                            <small class="text-muted">(@file.FileType, @(file.FileSize / 1024) KB)</small>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted fst-italic mt-3">No files uploaded.</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (Model.TotalPages > 1)
{
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center flex-wrap gap-2">
            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link"
                   asp-action="ProjectIdeas"
                   asp-route-projectTypeId="@Model.SelectedProjectTypeId"
                   asp-route-languageId="@Model.SelectedLanguageId"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-page="@(Model.CurrentPage - 1)">
                    &laquo; 
                </a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")" aria-current="@(i == Model.CurrentPage ? "page" : null)">
                    <a class="page-link"
                       asp-action="ProjectIdeas"
                       asp-route-projectTypeId="@Model.SelectedProjectTypeId"
                       asp-route-languageId="@Model.SelectedLanguageId"
                       asp-route-searchTerm="@Model.SearchTerm"
                       asp-route-page="@i">@i</a>
                </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                <a class="page-link"
                   asp-action="ProjectIdeas"
                   asp-route-projectTypeId="@Model.SelectedProjectTypeId"
                   asp-route-languageId="@Model.SelectedLanguageId"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-page="@(Model.CurrentPage + 1)">
                     &raquo;
                </a>
            </li>
        </ul>
    </nav>
}

@section Scripts {
    <script>
        function loadLanguages() {
            var projectTypeId = document.getElementById("projectTypeDropdown").value;
            var languageDropdown = document.getElementById("languageDropdown");

            if (!projectTypeId) {
                languageDropdown.innerHTML = '<option value="">-- Filter by Language --</option>';
                submitFilterForm();
                return;
            }

            fetch(`/Public/GetLanguagesByProjectTypeUsedInProjects?projectTypeId=${projectTypeId}`)
                .then(response => response.json())
                .then(data => {
                    languageDropdown.innerHTML = '<option value="">-- Filter by Language --</option>';
                    data.forEach(lang => {
                        let option = document.createElement("option");
                        option.value = lang.value;
                        option.text = lang.text;
                        languageDropdown.appendChild(option);
                    });

                    submitFilterForm(); // auto-submit
                })
                .catch(error => {
                    console.error('Failed to load languages:', error);
                });
        }

        function submitFilterForm() {
            document.getElementById("filterForm").submit();
        }

        // Search suggestion logic
        const searchInput = document.getElementById("searchInput");
        const suggestionsBox = document.getElementById("searchSuggestions");

        searchInput.addEventListener("input", function () {
            const term = this.value.trim();

            if (term.length < 2) {
                suggestionsBox.innerHTML = "";
                return;
            }

            fetch(`/Public/SearchSuggestions?term=${encodeURIComponent(term)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsBox.innerHTML = "";

                    data.forEach(item => {
                        const option = document.createElement("a");
                        option.classList.add("list-group-item", "list-group-item-action");
                        option.textContent = item;
                        option.href = "#";
                        option.addEventListener("click", function (e) {
                            e.preventDefault();
                            searchInput.value = item;
                            suggestionsBox.innerHTML = "";
                            submitFilterForm();
                        });
                        suggestionsBox.appendChild(option);
                    });
                })
                .catch(err => {
                    console.error("Autocomplete failed:", err);
                    suggestionsBox.innerHTML = "";
                });
        });

        document.addEventListener("click", function (e) {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.innerHTML = "";
            }
        });
    </script>
}
