@model IEnumerable<ProjectManagementSystem.DBModels.Email>
@{
    ViewData["Title"] = "Email Management";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
    int rowNumber = ViewBag.StartRowNumber != null ? (int)ViewBag.StartRowNumber : 1;   

}


<head>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<style>
    /* Consistent with Project Approval styling */
    .page-header {
        background: linear-gradient(135deg, #8C5DD1 0%, #6a3093 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .main-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    .sub-title {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .search-filter-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-box {
        flex-grow: 1;
        min-width: 250px;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.5rem 1rem;
        padding-right: 2.5rem;
        border: 1px solid #C8C6C1;
        border-radius: 20px;
        background: #E4EEFD;
        transition: all 0.3s;
    }

    .search-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #8C5DD1;
        cursor: pointer;
    }

    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        background: white;
        border: 1px solid #8C5DD1;
        border-radius: 20px;
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
        color: #8C5DD1;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }

        .filter-btn:hover {
            background: #8C5DD1;
            color: white;
        }

        .filter-btn.active {
            background: #8C5DD1;
            color: white;
            box-shadow: 0 2px 6px rgba(140, 93, 209, 0.3);
        }

    .approval-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

        .approval-table th {
            background: #8C5DD1;
            color: white;
            font-weight: 600;
            padding: 1rem;
            position: sticky;
            top: 0;
        }

        .approval-table td {
            padding: 0.8rem 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }

        .approval-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .approval-table tr:hover {
            background: #f0f0f0;
        }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
        border: 1px solid transparent;
    }

        .btn-icon.edit {
            color: #28a745;
            border-color: #28a745;
        }

            .btn-icon.edit:hover {
                background: #28a745;
                color: white;
            }

        .btn-icon.delete {
            color: #dc3545;
            border-color: #dc3545;
        }

            .btn-icon.delete:hover {
                background: #dc3545;
                color: white;
            }

        .btn-icon.view {
            color: #007bff;
            border-color: #007bff;
        }

            .btn-icon.view:hover {
                background: #007bff;
                color: white;
            }

        .btn-icon.save {
            color: #28a745;
            border-color: #28a745;
        }

            .btn-icon.save:hover {
                background: #28a745;
                color: white;
            }

        .btn-icon.cancel {
            color: #6c757d;
            border-color: #6c757d;
        }

            .btn-icon.cancel:hover {
                background: #6c757d;
                color: white;
            }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .pagination {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
    }

    .page-link {
        color: #8C5DD1;
        background: white;
        border: 1px solid #C8C6C1;
        padding: 0.5rem 0.9rem;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.3s;
    }

        .page-link:hover {
            background: #E4EEFD;
            border-color: #8C5DD1;
        }

    .page-item.active .page-link {
        background: #8C5DD1;
        color: white;
        border-color: #8C5DD1;
    }

    .action-buttons-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .btn-primary {
        background-color: #8C5DD1;
        border-color: #8C5DD1;
    }

    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }

        .btn-primary:hover,
        .btn-success:hover {
            opacity: 0.9;
        }

    /* Action Buttons Styling */
    .action-buttons-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.6rem 1.2rem;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: none;
        cursor: pointer;
    }

        .action-btn i {
            margin-right: 8px;
            font-size: 1rem;
        }

    .create-btn {
        background: linear-gradient(135deg, #8C5DD1 0%, #6a3093 100%);
        color: white;
    }

        .create-btn:hover {
            background: linear-gradient(135deg, #7d4bc0 0%, #5a2780 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(140, 93, 209, 0.3);
        }

    .upload-btn {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
    }

        .upload-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #155724 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

    /* Responsive adjustments */
    @@media (max-width: 576px) {
        .action-buttons-container {
            flex-direction: column;
            gap: 0.8rem;
        }

        .action-btn {
            width: 100%;
            padding: 0.7rem;
        }
    }

    .field-validation-error {
        font-size: 0.8rem;
        color: #dc3545;
        display: block;
        margin-top: 0.25rem;
    }

    .edit-mode .form-control.is-invalid {
        border-color: #dc3545;
    }
</style>

<div class="container mt-3">
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="main-title">Student Email Management</h2>
        <p class="sub-title">Manage student email addresses</p>
    </div>
    <div class="action-buttons-container" style="margin-bottom: 1.5rem;">
        <a asp-action="Create" class="action-btn create-btn">
            <i class="fas fa-plus-circle"></i> Add New Email
        </a>
        <a asp-action="UploadBulk" class="action-btn upload-btn">
            <i class="fas fa-file-upload"></i> Bulk Upload
        </a>
    </div>
    <form method="get" asp-action="Index" class="mb-3">
        <div class="search-box">
            <select name="selectedYear" onchange="this.form.submit()" class="search-input">
                <option value="">-- Select Academic Year --</option>
                @foreach (var year in (List<ProjectManagementSystem.DBModels.AcademicYear>)ViewBag.AcademicYears)

                {
                    if (ViewBag.SelectedYear == year.YearRange)
                    {
                        <option value="@year.YearRange" selected>@year.YearRange</option>
                    }
                    else
                    {
                        <option value="@year.YearRange">@year.YearRange</option>
                    }
                }
            </select>
        </div>
    </form>

    @if (!string.IsNullOrEmpty((string)ViewBag.SelectedYear))
    {
      
        <!-- Email Table -->
        <div class="table-responsive">
            <table class="approval-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Email Address</th>
                        <th>Roll Number</th>
                        <th>Class</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr id="row-@item.EmailPkId">
                            <td>@rowNumber</td>
                            <td>
                                <span class="view-mode" data-field="EmailAddress">@item.EmailAddress</span>
                                <input type="email" class="form-control edit-mode" name="EmailAddress"
                                       value="@item.EmailAddress" style="display:none;"
                                       data-val="true"
                                       data-val-required="Email address is required"
                                       data-val-email="Invalid email format" />
                                <span class="text-danger field-validation-error" data-valmsg-for="EmailAddress"></span>
                            </td>
                            <td>
                                <span class="view-mode" data-field="RollNumber">@item.RollNumber</span>
                                <input type="text" class="form-control edit-mode" name="RollNumber"
                                       value="@item.RollNumber" style="display:none;"
                                       data-val="true"
                                       data-val-required="Roll number is required" />
                                <span class="text-danger field-validation-error" data-valmsg-for="RollNumber"></span>
                            </td>
                            <td>
                                <span class="view-mode" data-field="Class">@item.Class</span>
                                <input type="text" class="form-control edit-mode" name="Class"
                                       value="@item.Class" style="display:none;"
                                       data-val="true"
                                       data-val-required="Class is required" />
                                <span class="text-danger field-validation-error" data-valmsg-for="Class"></span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <div class="view-mode">
                                        <button type="button" class="btn-icon edit edit-btn" data-id="@item.EmailPkId">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn-icon delete delete-btn" data-id="@item.EmailPkId">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    <div class="edit-mode" style="display:none">
                                        <button type="button" class="btn-icon save save-btn" data-id="@item.EmailPkId">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn-icon cancel cancel-btn" data-id="@item.EmailPkId">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        rowNumber++;
                    }
                </tbody>
            </table>
            @if (Model.Any())
            {
                <div class="pagination-container">
                    <ul class="pagination">
                        @for (int i = 1; i <= (int)ViewBag.TotalPages; i++)
                        {
                            <li class="page-item @(i == (int)ViewBag.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="Index"
                                   asp-route-page="@i"
                                   asp-route-selectedYear="@ViewBag.SelectedYear">
                                    @i
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            Please select an Academic Year to view the emails.
        </div>
    }
</div>
@Html.AntiForgeryToken()
@section Scripts {
    <script>
        $(document).ready(function () {

            // EDIT BUTTON
            $(document).on('click', '.edit-btn', function () {
                console.log("here edit click..................")
                const row = $(this).closest('tr');
                row.find('.view-mode').hide();
                row.find('.edit-mode').show();
                row.find('.view-mode.btn-group').hide();
                row.find('.edit-mode.btn-group').show();
            });

            // CANCEL BUTTON
            $(document).on('click', '.cancel-btn', function () {
                const row = $(this).closest('tr');
                row.find('.view-mode').show();
                row.find('.edit-mode').hide();
                row.find('.view-mode.btn-group').show();
                row.find('.edit-mode.btn-group').hide();
                row.find('.is-invalid').removeClass('is-invalid');
        // SAVE BUTTON - CORRECTED VERSION
$(document).on('click', '.save-btn', function () {
    btn = $(this);
    const row = btn.closest('tr');
    const id = btn.data('id');
                const btn = $(this);
    // Get form values
    const formData = {
        Email_PkId: id,
        EmailAddress: row.find('[name="EmailAddress"]').val().trim(),
        RollNumber: row.find('[name="RollNumber"]').val().trim(),
        Class: row.find('[name="Class"]').val().trim(),
        AcademicYear_pkId: @(Model.FirstOrDefault()?.AcademicYearPkId ?? 0)
    };
                // Prepare data
    // Clear previous validation errors
    row.find('.is-invalid').removeClass('is-invalid');
    row.find('.field-validation-error').text('');

    // Validate fields
    let isValid = true;
    if (!formData.EmailAddress) {
        row.find('[data-valmsg-for="EmailAddress"]').text('Email address is required');
        row.find('[name="EmailAddress"]').addClass('is-invalid');
        isValid = false;
    }
    if (!formData.RollNumber) {
        row.find('[data-valmsg-for="RollNumber"]').text('Roll number is required');
        row.find('[name="RollNumber"]').addClass('is-invalid');
        isValid = false;
    }
    if (!formData.Class) {
        row.find('[data-valmsg-for="Class"]').text('Class is required');
        row.find('[name="Class"]').addClass('is-invalid');
        isValid = false;
    }

    if (!isValid) {
        return;
    }

    // Show loading icon
    btn.html('<i class="fas fa-spinner fa-spin"></i>');
                    EmailAddress: row.find('[name="EmailAddress"]').val().trim(),
    // AJAX Save
    $.ajax({
        url: '/Email/EditInline/' + id,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {
            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
        },
                success: function (response) {
                    if (response.success) {
                        // Update UI
                        row.find('[data-field="EmailAddress"]').text(formData.EmailAddress);
                        row.find('[data-field="RollNumber"]').text(formData.RollNumber);
                        row.find('[data-field="Class"]').text(formData.Class);

                        // Switch modes
                        row.find('.view-mode').show();
                        row.find('.edit-mode').hide();

                        Swal.fire('Success!', 'Updated successfully', 'success');
                    } else {
                        Swal.fire('Error!', response.message || 'Update failed', 'error');
                        // Show server-side validation errors if any
                        if (response.errors) {
                            for (const [key, value] of Object.entries(response.errors)) {
                                row.find(`[data-valmsg-for="${key}"]`).text(value.join(', '));
                                row.find(`[name="${key}"]`).addClass('is-invalid');
                            }
                        }
                    }
                },
                error: function (xhr) {
                    let errorMsg = 'Request failed';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    Swal.fire('Error!', errorMsg, 'error');
                },
                complete: function () {
                    btn.html('<i class="fas fa-check"></i>');
                }
            });
        });
     });

                    // DELETE BUTTON - UPDATED VERSION
        $(document).on('click', '.delete-btn', function () {
            const btn = $(this);
            const id = btn.data('id');

            Swal.fire({
                title: 'Confirm Delete',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Delete'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading icon
                    btn.html('<i class="fas fa-spinner fa-spin"></i>');

                    // Get anti-forgery token
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    $.ajax({
                        url: '/Email/DeleteInline/' + id,
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': token
                        },
                        data: JSON.stringify({ id: id }),
                        contentType: 'application/json',
                        success: function (response) {
                            if (response.success) {
                                $('#row-' + id).fadeOut(300, function () {
                                    $(this).remove();
                                    // Update row numbers after deletion
                                    updateRowNumbers();
                                });
                                Swal.fire('Deleted!', 'Record removed', 'success');
                            } else {
                                Swal.fire('Error!', response.message || 'Delete failed', 'error');
                            }
                        },
                        error: function (xhr) {
                            let errorMsg = 'Request failed';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            }
                            Swal.fire('Error!', errorMsg, 'error');
                        },
                        complete: function () {
                            btn.html('<i class="fas fa-trash-alt"></i>');
                        }
                    });
                }
            });
        });

        // Helper function to update row numbers after deletion
        function updateRowNumbers() {
            $('tbody tr').each(function(index) {
                $(this).find('td:first').text(index + 1);
            });
        }

        });
    </script>
}
