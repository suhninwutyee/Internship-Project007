@model IEnumerable<ProjectManagementSystem.DBModels.NotificationViewModel>

<h2 class="mb-3">Your Notifications (Student)</h2>

<!-- === COUNTERS + MARK ALL BUTTON === -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <span class="fw-bold">Unread:</span>
        <span id="unreadCount" class="badge bg-danger">0</span>
        <span class="ms-3 fw-bold">Read:</span>
        <span id="readCount" class="badge bg-success">0</span>
    </div>
    <button class="btn btn-primary btn-sm" onclick="markAllAsRead()">Mark All As Read</button>
</div>

<!-- === NOTIFICATION LIST === -->
<div class="list-group">
    @if (Model.Any())
    {
        foreach (var notif in Model.OrderByDescending(n => n.CreatedAt))
        {
            bool isUnread = !(notif.IsRead ?? false);

            <div class="list-group-item @(isUnread ? "list-group-item-unread" : "list-group-item-read")"
                 id="notif-@notif.Id">

                <div>
                    <strong>@notif.Title</strong> - @notif.Message <br />
                    @if (!string.IsNullOrEmpty(notif.DeadlineStatus))
                    {
                        <span class="badge bg-danger">@notif.DeadlineStatus</span>
                    }
                    <br />
                    <small>@notif.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                </div>

                @* Only show Confirm Read button for unread notifications *@
                @if (isUnread)
                {
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="confirmRead(@notif.Id)">
                        Confirm Read
                    </button>
                }
            </div>
        }
    }
    else
    {
        <div>No notifications</div>
    }
</div>

<!-- === STYLE === -->
<style>
    .list-group-item-unread {
        background-color: #f8d7da !important; /* light red */
        font-weight: bold;
    }

    .list-group-item-read {
        background-color: #d1e7dd !important; /* light green */
        font-weight: normal;
    }
</style>
@* <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 *@
<script>
    document.addEventListener("DOMContentLoaded", function () {
        loadUnreadCount();
        loadReadCount();
    });

    // Confirm single notification
    function confirmRead(id) {
        fetch('/Notifications/MarkAsRead', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
        })
        .then(res => res.json())
        .then(() => {
            const notif = document.getElementById("notif-" + id);
            if (notif) {
                notif.classList.remove("list-group-item-unread");
                notif.classList.add("list-group-item-read");

                // Remove button inside notification
                const button = notif.querySelector("button");
                if (button) button.remove();
            }
            loadUnreadCount();
            loadReadCount();
        })
        .catch(err => console.error("Error marking notification as read:", err));
    }

    // Mark all as read
    function markAllAsRead() {
        fetch('/Notifications/MarkAllAsRead', { method: 'POST' })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                document.querySelectorAll(".list-group-item-unread").forEach(item => {
                    item.classList.remove("list-group-item-unread");
                    item.classList.add("list-group-item-read");
                });

                document.querySelectorAll(".list-group-item button").forEach(btn => btn.remove());

                loadUnreadCount();
                loadReadCount();
            }
        })
        .catch(err => console.error("Error marking all notifications as read:", err));
    }

    // Load unread count
    function loadUnreadCount() {
        fetch('/Notifications/GetUnreadCount')
        .then(res => res.json())
        .then(count => {
            const unreadElem = document.getElementById("unreadCount");
            if (unreadElem) unreadElem.textContent = count;
        })
        .catch(err => console.error("Error loading unread count:", err));
    }

    // Load read count
    function loadReadCount() {
        fetch('/Notifications/GetReadCount')
        .then(res => res.json())
        .then(count => {
            const readElem = document.getElementById("readCount");
            if (readElem) readElem.textContent = count;
        })
        .catch(err => console.error("Error loading read count:", err));
    }
</script>

