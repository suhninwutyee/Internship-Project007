@model List<ProjectManagementSystem.Models.CompanyViewModel>
@{
    ViewData["Title"] = "Company List";
    // int count = (Model.PageNumber - 1) * Model.PageSize + 1;
    // var total = Model.TotalItemCount;
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}

<head>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<style>
    :root {
        --primary: #8C5DD1;
        --primary-light: #E4EEFD;
        --danger: #dc3545;
        --success: #28a745;
        --gray: #6c757d;
        --light-gray: #f8f9fa;
        --white: #ffffff;
        --border-radius: 6px;
        --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease;
    }

    .company-management-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 15px;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, #6a3093 100%);
        color: var(--white);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.3rem;
    }

    .page-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .add-form {
        background-color: var(--white);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow);
        display: flex;
        gap: 0.8rem;
    }

        .add-form input[type="text"] {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
        }

            .add-form input[type="text"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(140, 93, 209, 0.2);
            }

    .btn {
        padding: 0.6rem 1rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
    }

    .btn-primary {
        background-color: var(--primary);
        color: var(--white);
    }

        .btn-primary:hover {
            background-color: #7a4bc3;
        }

    .btn-danger {
        background-color: var(--danger);
        color: var(--white);
    }

        .btn-danger:hover {
            background-color: #c82333;
        }

    .btn-secondary {
        background-color: var(--gray);
        color: var(--white);
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }

    .company-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        font-size: 0.95rem;
    }

        .company-table th {
            background-color: var(--primary);
            color: var(--white);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .company-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .company-table tr:last-child td {
            border-bottom: none;
        }

        .company-table tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        .company-table tr:hover {
            background-color: rgba(140, 93, 209, 0.05);
        }

    .action-buttons {
        display: flex;
        gap: 0.4rem;
    }

    .edit-form {
        display: flex;
        gap: 0.4rem;
        align-items: center;
    }

        .edit-form input[type="text"] {
            padding: 0.4rem 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
            width: 100%;
            max-width: 250px;
        }

            .edit-form input[type="text"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(140, 93, 209, 0.2);
            }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .add-form {
            flex-direction: column;
            gap: 0.6rem;
        }

        .action-buttons {
            flex-wrap: wrap;
        }

        .edit-form {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4rem;
        }

            .edit-form input[type="text"] {
                max-width: 100%;
            }
    }
</style>

<div class="company-management-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Company Management</h1>
        <p class="page-subtitle">Manage partner companies</p>
    </div>

    <!-- Add Company Form -->
    <div class="add-form">
        <form id="createCompanyForm" asp-action="CreateCommpany" method="post" class="w-100">
            @Html.AntiForgeryToken()
            <input type="text" name="CompanyName" placeholder="Enter company name" required maxlength="100" />
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add
            </button>
        </form>
    </div>

    <!-- Companies Table -->
    <div class="table-responsive">
        <table class="company-table">
            <thead>
                <tr>
                    <th>Company Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="companiesTableBody">
                @foreach (var item in Model)
                {
                    <tr id="row-@item.Company_pkId">
                        <td>
                            <span id="name-@item.Company_pkId">@item.CompanyName</span>
                            <div id="edit-form-@item.Company_pkId" style="display:none;">
                                <form class="edit-form edit-company-form" data-id="@item.Company_pkId">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="Company_pkId" value="@item.Company_pkId" />
                                    <input type="text" name="CompanyName" value="@item.CompanyName" required maxlength="100" />
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                                onclick="hideEditForm(@item.Company_pkId)">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button id="edit-btn-@item.Company_pkId" class="btn btn-primary btn-sm"
                                        onclick="showEditForm(@item.Company_pkId)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-danger btn-sm"
                                        onclick="confirmDelete(@item.Company_pkId, '@item.CompanyName')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Function to show edit form
        function showEditForm(id) {
            document.getElementById('name-' + id).style.display = 'none';
            document.getElementById('edit-form-' + id).style.display = 'block';
            document.getElementById('edit-btn-' + id).style.display = 'none';
        }

        // Function to hide edit form
        function hideEditForm(id) {
            document.getElementById('name-' + id).style.display = 'inline';
            document.getElementById('edit-form-' + id).style.display = 'none';
            document.getElementById('edit-btn-' + id).style.display = 'inline-block';
        }

        // Function to confirm delete
        function confirmDelete(id, companyName) {
            Swal.fire({
                title: 'Delete Company',
                html: `Are you sure you want to delete <strong>${companyName}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#dc3545',
                confirmButtonText: 'Delete'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteCompany(id);
                }
            });
        }

        // AJAX function to delete company
        function deleteCompany(id) {
            $.ajax({
                url: '/Company/Delete',
                type: 'POST',
                data: {
                    id: id,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        $('#row-' + id).fadeOut(300, function() {
                            $(this).remove();
                        });
                        showSuccessMessage(response.message || 'Company deleted successfully');
                    } else {
                        showErrorMessage(response.message || 'Error deleting company');
                    }
                },
                error: function(xhr) {
                    showErrorMessage(xhr.responseJSON?.message || 'An error occurred');
                }
            });
        }

        // AJAX form submission for create
        $('#createCompanyForm').on('submit', function(e) {
            e.preventDefault();
            var form = $(this);
            var formData = form.serialize();

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                success: function(response, textStatus, xhr) {
                    console.log(response);
                    if (xhr.status === 200) {
                        // Add new row to table
                        addCompanyRow(response);
                        // Reset form
                        form.trigger('reset');
                        // Show success message
                        showSuccessMessage(response.message || 'Company added successfully');
                    } else {
                        showErrorMessage(response.message || 'Error adding company');
                    }
                },
                error: function(xhr) {
                    showErrorMessage(xhr.responseJSON?.message || 'An error occurred');
                }
            });
        });

        // AJAX form submission for edit
        $(document).on('submit', '.edit-company-form', function(e) {
            e.preventDefault();
            var form = $(this);
            var formData = form.serialize();
            var id = form.data('id');

            $.ajax({
                url: '/Company/Edit',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        // Update the displayed name
                        $('#name-' + id).text(response.companyName);
                        // Hide the edit form
                        hideEditForm(id);
                        // Show success message
                        showSuccessMessage(response.message || 'Company updated successfully');
                    } else {
                        showErrorMessage(response.message || 'Error updating company');
                    }
                },
                error: function(xhr) {
                    showErrorMessage(xhr.responseJSON?.message || 'An error occurred');
                }
            });
        });

        // Function to add new company row
        function addCompanyRow(company) {
            console.log("in add company......................." + company)
            var newRow = `
                <tr id="row-${company.company_pkId}">
                    <td>
                        <span id="name-${company.company_pkId}">${company.companyName}</span>
                        <div id="edit-form-${company.company_pkId}" style="display:none;">
                            <form class="edit-form edit-company-form" data-id="${company.company_pkId}">
                                <input name="__RequestVerificationToken" type="hidden" value="${$('input[name="__RequestVerificationToken"]').val()}" />
                                <input type="hidden" name="Company_pkId" value="${company.company_pkId}" />
                                <input type="text" name="CompanyName" value="${company.companyName}" required maxlength="100" />
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="hideEditForm(${company.company_pkId})">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button id="edit-btn-${company.company_pkId}" class="btn btn-primary btn-sm"
                                    onclick="showEditForm(${company.company_pkId})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button type="button" class="btn btn-danger btn-sm"
                                    onclick="confirmDelete(${company.company_pkId}, '${company.companyName}')">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            $('#companiesTableBody').append(newRow);
        }

        // Helper functions for showing messages
        function showSuccessMessage(message) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: message,
                confirmButtonColor: '#8C5DD1',
                timer: 3000
            });
        }

        function showErrorMessage(message) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: message,
                confirmButtonColor: '#8C5DD1'
            });
        }
    </script>
}