@model List<ProjectManagementSystem.Models.CompanyViewModel>
@{
    ViewData["Title"] = "Companies";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}
}

<style>
    body {
        background: linear-gradient(135deg, #e4eefd);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .btn-primary {
        background-color: #8c5dd1;
        border-color: #8c5dd1;
    }

        .btn-primary:hover {
            background-color: #7a4bc2;
            border-color: #7a4bc2;
        }

    .company-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

        .company-table th {
            background-color: #8c5dd1;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .company-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .company-table tr:hover {
            background-color: #f9f5ff;
        }

    .add-form {
        background-color: #f9f5ff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

        .add-form input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 300px;
        }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
</style>

<head>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<style>
    :root {
        --primary: #8C5DD1;
        --primary-light: #E4EEFD;
        --danger: #dc3545;
        --success: #28a745;
        --gray: #6c757d;
        --light-gray: #f8f9fa;
        --white: #ffffff;
        --border-radius: 6px;
        --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease;
    }

    .company-management-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 15px;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, #6a3093 100%);
        color: var(--white);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.3rem;
    }

    .page-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .add-form {
        background-color: var(--white);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1.5rem;
        box-shadow: var(--box-shadow);
        display: flex;
        gap: 0.8rem;
    }

        .add-form input[type="text"] {
            flex: 1;
            padding: 0.6rem 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
        }

            .add-form input[type="text"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(140, 93, 209, 0.2);
            }

    .btn {
        padding: 0.6rem 1rem;
        border-radius: var(--border-radius);
        font-weight: 500;
        font-size: 0.9rem;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
    }

    .btn-primary {
        background-color: var(--primary);
        color: var(--white);
    }

        .btn-primary:hover {
            background-color: #7a4bc3;
        }

    .btn-danger {
        background-color: var(--danger);
        color: var(--white);
    }

        .btn-danger:hover {
            background-color: #c82333;
        }

    .btn-secondary {
        background-color: var(--gray);
        color: var(--white);
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }

    .company-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--box-shadow);
        font-size: 0.95rem;
    }

        .company-table th {
            background-color: var(--primary);
            color: var(--white);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .company-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .company-table tr:last-child td {
            border-bottom: none;
        }

        .company-table tr:nth-child(even) {
            background-color: var(--light-gray);
        }

        .company-table tr:hover {
            background-color: rgba(140, 93, 209, 0.05);
        }

    .action-buttons {
        display: flex;
        gap: 0.4rem;
    }

    .edit-form {
        display: flex;
        gap: 0.4rem;
        align-items: center;
    }

        .edit-form input[type="text"] {
            padding: 0.4rem 0.8rem;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            transition: var(--transition);
            width: 100%;
            max-width: 250px;
        }

            .edit-form input[type="text"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(140, 93, 209, 0.2);
            }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .add-form {
            flex-direction: column;
            gap: 0.6rem;
        }

        .action-buttons {
            flex-wrap: wrap;
        }

        .edit-form {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.4rem;
        }

            .edit-form input[type="text"] {
                max-width: 100%;
            }
    }
</style>

<div class="company-management-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Company Management</h1>
        <p class="page-subtitle">Manage partner companies</p>
    </div>

    <!-- Add Company Form -->
    <div class="add-form">
        <form id="createCompanyForm" asp-action="Create" asp-controller="Company" method="post" class="w-100">
            @Html.AntiForgeryToken()
            <input type="text" name="CompanyName" placeholder="Enter company name" required maxlength="100" />
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add
            </button>
        </form>
    </div>

    <!-- Companies Table -->
    <div class="table-responsive">
        <table class="company-table">
            <thead>
                <tr>
                    <th>Company Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="companiesTableBody">
                @foreach (var item in Model)
                {
                    <tr id="row-@item.Company_pkId">
                        <td>
                            <span id="name-@item.Company_pkId">@item.CompanyName</span>
                            <div id="edit-form-@item.Company_pkId" style="display:none;">
                                <form class="edit-form edit-company-form"
                                      data-id="@item.Company_pkId"
                                      asp-action="Edit"
                                      asp-controller="Company"
                                      method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="Company_pkId" value="@item.Company_pkId" />
                                    <input type="text" name="CompanyName" value="@item.CompanyName" required maxlength="100" />
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                                onclick="hideEditForm(@item.Company_pkId)">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button id="edit-btn-@item.Company_pkId" class="btn btn-primary btn-sm"
                                        onclick="showEditForm(@item.Company_pkId)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-danger btn-sm"
                                        onclick="confirmDelete(@item.Company_pkId, '@item.CompanyName')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Document ready handler
        $(function() {
            initCompanyForms();
        });

        function initCompanyForms() {
            // Create
            $('#createCompanyForm').on('submit', function(e) {
                e.preventDefault();
                submitCreateForm($(this));
            });

            // Edit (delegated)
            $(document).on('submit', '.edit-company-form', function(e) {
                e.preventDefault();
                submitEditForm($(this));
            });
        }

        // AJAX error
        function handleAjaxError(xhr) {
            let errorMsg = 'An unexpected error occurred';
            try {
                if (xhr.responseJSON) {
                    errorMsg = xhr.responseJSON.message || errorMsg;
                    if (xhr.responseJSON.errors) {
                        const errorList = Object.values(xhr.responseJSON.errors).flat();
                        errorMsg += ': ' + errorList.join(', ');
                    }
                } else if (xhr.responseText) {
                    errorMsg = xhr.responseText;
                }
            } catch (e) {}
            Swal.fire({ icon: 'error', title: 'Error', text: errorMsg, confirmButtonColor: '#8C5DD1' });
        }

        // Create
        function submitCreateForm(form) {
            Swal.fire({ title: 'Creating Company', text: 'Please wait...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    Swal.close();
                    if (response && response.success) {
                        if (response.data) addCompanyRow(response.data);
                        form.trigger('reset');
                        showSuccess('Company created successfully');
                    } else {
                        showError(response?.message || 'Failed to create company');
                    }
                },
                error: function(xhr) { Swal.close(); handleAjaxError(xhr); }
            });
        }

        // Edit
        function submitEditForm(form) {
            const companyId = form.data('id');
            Swal.fire({ title: 'Updating Company', text: 'Please wait...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    Swal.close();
                    if (response && response.success) {
                        const newName = response.data?.companyName || form.find('input[name="CompanyName"]').val();
                        $('#name-' + companyId).text(newName);
                        hideEditForm(companyId);
                        showSuccess('Company updated successfully');
                    } else {
                        showError(response?.message || 'Failed to update company');
                    }
                },
                error: function(xhr) { Swal.close(); handleAjaxError(xhr); }
            });
        }

        // Delete
        function confirmDelete(id, name) {
            Swal.fire({
                title: 'Confirm Delete',
                html: `Are you sure you want to delete <strong>${escapeHtml(name)}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#dc3545',
                confirmButtonText: 'Delete'
            }).then((result) => { if (result.isConfirmed) deleteCompany(id); });
        }

        function deleteCompany(id) {
            Swal.fire({ title: 'Deleting Company', text: 'Please wait...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            $.ajax({
                url: '@Url.Action("Delete", "Company")',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                success: function(response) {
                    Swal.close();
                    if (response && response.success) {
                        $('#row-' + id).fadeOut(300, function() { $(this).remove(); });
                        showSuccess('Company deleted successfully');
                    } else {
                        showError(response?.message || 'Failed to delete company');
                    }
                },
                error: function(xhr) { Swal.close(); handleAjaxError(xhr); }
            });
        }

        // Add new row dynamically
        function addCompanyRow(company) {
            const newRow = `
                <tr id="row-${company.company_pkId}">
                    <td>
                        <span id="name-${company.company_pkId}">${escapeHtml(company.companyName)}</span>
                        <div id="edit-form-${company.company_pkId}" style="display:none;">
                            <form class="edit-form edit-company-form"
                                  data-id="${company.company_pkId}"
                                  action="@Url.Action("Edit", "Company")"
                                  method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Company_pkId" value="${company.company_pkId}" />
                                <input type="text" name="CompanyName" value="${escapeHtml(company.companyName)}" required maxlength="100" />
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="hideEditForm(${company.company_pkId})"><i class="fas fa-times"></i> Cancel</button>
                                </div>
                            </form>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button id="edit-btn-${company.company_pkId}" class="btn btn-primary btn-sm" onclick="showEditForm(${company.company_pkId})"><i class="fas fa-edit"></i> Edit</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete(${company.company_pkId}, '${escapeHtml(company.companyName).replace(/'/g, "\\'")}')"><i class="fas fa-trash-alt"></i> Delete</button>
                        </div>
                    </td>
                </tr>
            `;
            $('#companiesTableBody').append(newRow);
        }

        // Helpers
        function showEditForm(id) { $(`#name-${id}`).hide(); $(`#edit-form-${id}`).show(); $(`#edit-btn-${id}`).hide(); }
        function hideEditForm(id) { $(`#name-${id}`).show(); $(`#edit-form-${id}`).hide(); $(`#edit-btn-${id}`).show(); }
        function showSuccess(message) { Swal.fire({ icon: 'success', title: 'Success', text: message, confirmButtonColor: '#8C5DD1', timer: 3000 }); }
        function showError(message) { Swal.fire({ icon: 'error', title: 'Error', text: message, confirmButtonColor: '#8C5DD1' }); }
        function escapeHtml(unsafe) { return unsafe?.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;") || ''; }
    </script>
}
