@using ProjectManagementSystem.Controllers
@model ProjectApprovalViewModel
@{
    ViewData["Title"] = ViewBag.PageTitle;
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .main-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .sub-title {
            font-size: 14px;
            color: #6c757d;
            margin: 0;
        }

        .search-filter-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: #e9ecef;
            color: #495057;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

            .filter-btn.active {
                background: #8C5DD1;
                color: white;
            }

        .search-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex-grow: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding-right: 40px;
        }

        .search-btn {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 40px;
            background: transparent;
            border: none;
            color: #6c757d;
        }

        .date-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .date-range-container input {
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                max-width: 150px;
            }

        .action-buttons-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .export-btn {
            padding: 8px 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .export-btn:hover {
                background: #f8f9fa;
            }

        .approval-table {
            width: 100%;
            border-collapse: collapse;
        }

            .approval-table th {
                background: #f8f9fa;
                padding: 12px 15px;
                text-align: left;
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
            }

            .approval-table td {
                padding: 12px 15px;
                border-bottom: 1px solid #dee2e6;
                vertical-align: middle;
            }

            .approval-table tr:hover {
                background-color: #f8f9fa;
            }

        .project-name {
            font-weight: 500;
            color: #333;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            position: relative;
        }

        .approve {
            background: #d4edda;
            color: #155724;
        }

        .reject {
            background: #f8d7da;
            color: #721c24;
        }

        .view {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tooltip {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .btn-icon:hover .tooltip {
            opacity: 1;
        }

        .pagination-container {
            margin-top: 20px;
        }

        .pagination {
            display: flex;
            gap: 5px;
            list-style: none;
            padding: 0;
        }

        .page-item {
            display: inline-block;
        }

        .page-link {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            color: #8C5DD1;
            text-decoration: none;
        }

        .page-item.active .page-link {
            background: #8C5DD1;
            color: white;
            border-color: #8C5DD1;
        }

        .no-print {
            display: block;
        }

        @@media print {
            .no-print {
                display: none !important;
            }

            body {
                padding: 20px;
                font-size: 12px;
            }

            .approval-table {
                font-size: 12px;
            }

                .approval-table th, .approval-table td {
                    padding: 6px 8px;
                }
        }
    </style>
</head>

<div class="container mt-3">
    

    <div class="search-filter-container">
        <form asp-action="Index" method="get" class="search-form">
            <div class="search-box">
                <input type="text" class="search-input" name="searchString" value="@Model.SearchString" placeholder="Search projects, students or emails...">
                <button type="submit" class="search-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="date-range-container">
                <input type="date" name="fromDate" value="@Model.FromDate?.ToString("yyyy-MM-dd")" class="form-control">
                <span>to</span>
                <input type="date" name="toDate" value="@Model.ToDate?.ToString("yyyy-MM-dd")" class="form-control">
            </div>
            <input type="hidden" name="statusFilter" value="@Model.StatusFilter" />
        </form>
        <div class="filter-buttons">
            <button type="button" class="filter-btn @(Model.StatusFilter == "all" ? "active" : "")" onclick="updateStatusFilter('all')">All (@Model.TotalCount)</button>
            <button type="button" class="filter-btn @(Model.StatusFilter == "Pending" ? "active" : "")" onclick="updateStatusFilter('Pending')">Pending (@Model.PendingCount)</button>
            <button type="button" class="filter-btn @(Model.StatusFilter == "Approved" ? "active" : "")" onclick="updateStatusFilter('Approved')">Approved (@Model.ApprovedCount)</button>
            <button type="button" class="filter-btn @(Model.StatusFilter == "Rejected" ? "active" : "")" onclick="updateStatusFilter('Rejected')">Rejected (@Model.RejectedCount)</button>
            <button class="export-btn" onclick="printTable();"><i class="fas fa-print"></i> Print</button>
            <button class="export-btn" onclick="exportToExcel();"><i class="fas fa-file-excel"></i> Export</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="approval-table" id="projectsTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Project Name</th>
                    <th>Student Name</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th class="no-print">Actions</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int counter = (Model.PageNumber - 1) * Model.PageSize + 1;
                }
                @foreach (var project in Model.Projects)
                {
                    <tr>
                        <td>@(counter++)</td>
                        <td class="project-name">@project.ProjectName</td>
                        @{
                            var leader = project.ProjectMembers?.FirstOrDefault(m => m.Role == "Leader");
                            var leaderName = leader?.Student?.StudentName ?? "No Leader";
                        }
                        <td>@leaderName</td>

                        <td>@(project.ProjectSubmittedDate.HasValue? project.ProjectSubmittedDate.Value.ToString("dd-MMM-yyyy") : "Not submitted")</td>
                        <td><span class="status-badge status-@project.Status.ToLower()">@project.Status</span></td>
                        <td class="no-print">
                            <div class="action-buttons">
                                @if (project.Status != "Approved")
                                {
                                    <button class="btn-icon approve" onclick="confirmApprove(@project.Project_pkId, '@Html.Raw(project.ProjectName.Replace("'", "\\'"))', '@Html.Raw(project.CreatedBy?.Replace("'", "\\'") ?? "")')">
                                        <i class="fas fa-check"></i><span class="tooltip">Approve</span>
                                    </button>
                                }
                                @if (project.Status != "Rejected")
                                {
                                    <button class="btn-icon reject" onclick="confirmReject(@project.Project_pkId, '@Html.Raw(project.ProjectName.Replace("'", "\\'"))', '@Html.Raw(project.CreatedBy?.Replace("'", "\\'") ?? "")')">
                                        <i class="fas fa-times"></i><span class="tooltip">Reject</span>
                                    </button>
                                }
                                <a href="@Url.Action("Details", "ProjectApproval", new { id = project.Project_pkId })" class="btn-icon view">
                                    <i class="fas fa-eye"></i><span class="tooltip">View</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="pagination-container no-print">
            <ul class="pagination">
                @if (Model.PageNumber > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = Model.StatusFilter, searchString = Model.SearchString, fromDate = Model.FromDate?.ToString("yyyy-MM-dd"), toDate = Model.ToDate?.ToString("yyyy-MM-dd"), pageNumber = Model.PageNumber - 1 })">&laquo;</a>
                    </li>
                }
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = Model.StatusFilter, searchString = Model.SearchString, fromDate = Model.FromDate?.ToString("yyyy-MM-dd"), toDate = Model.ToDate?.ToString("yyyy-MM-dd"), pageNumber = i })">@i</a>
                    </li>
                }
                @if (Model.PageNumber < Model.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = Model.StatusFilter, searchString = Model.SearchString, fromDate = Model.FromDate?.ToString("yyyy-MM-dd"), toDate = Model.ToDate?.ToString("yyyy-MM-dd"), pageNumber = Model.PageNumber + 1 })">&raquo;</a>
                    </li>
                }
            </ul>
        </div>
    }
</div>

<div id="printSection" style="display:none;">
    <h2>Projects Report - @DateTime.Now.ToString("yyyy-MM-dd")</h2>
    <p>Status: @Model.StatusFilter</p>
    @if (!string.IsNullOrEmpty(Model.SearchString))
    {
        <p>Search: @Model.SearchString</p>
    }
    @if (Model.FromDate.HasValue || Model.ToDate.HasValue)
    {
        <p>Date Range: @Model.FromDate?.ToString("dd-MMM-yyyy") to @Model.ToDate?.ToString("dd-MMM-yyyy")</p>
    }
    <table class="approval-table" style="width:100%; border-collapse:collapse;">
        <thead>
            <tr>
                <th>No.</th>
                <th>Project Name</th>
                <th>Student Name</th>
                <th>Submitted</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @{
                int count = 0;
            }
            @foreach (var project in Model.Projects)
            {
                var leader = project.ProjectMembers?.FirstOrDefault(m => m.Role == "Leader");
                <tr>
                    <td>@(++count)</td>
                    <td>@project.ProjectName</td>
                    <td>@(leader != null ? leader.Student.StudentName : "No Leader")</td>
                    <td>@(project.ProjectSubmittedDate?.ToString("dd-MMM-yyyy") ?? "Not submitted")</td>
                    <td>@project.Status</td>
                </tr>
            }
        </tbody>
    </table>

</div>

@Html.AntiForgeryToken()

@section Scripts {
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function updateStatusFilter(status){
            document.querySelector('input[name="statusFilter"]').value=status;
            document.querySelector('.search-form').submit();
        }
        function confirmApprove(projectId,projectName,createdBy){
            Swal.fire({
                title:'Approve Project',
                html:`<p>Project: <strong>${projectName}</strong></p><p>Submitted by: <strong>${createdBy}</strong></p><p>Are you sure you want to approve this project?</p>`,
                icon:'question',
                showCancelButton:true,
                confirmButtonColor:'#8C5DD1',
                cancelButtonColor:'#C8C6C1',
                confirmButtonText:'Yes, approve it!',
                cancelButtonText:'Cancel'
            }).then((result)=>{if(result.isConfirmed){submitApprove(projectId);}});
        }
        function confirmReject(projectId,projectName,createdBy){
            Swal.fire({
                title:'Reject Project',
                html:`<p>Project: <strong>${projectName}</strong></p><p>Submitted by: <strong>${createdBy}</strong></p><textarea id="swal-reject-reason" class="swal2-textarea" placeholder="Please provide a reason for rejection..." required></textarea>`,
                icon:'warning',
                showCancelButton:true,
                confirmButtonColor:'#8C5DD1',
                cancelButtonColor:'#C8C6C1',
                confirmButtonText:'Yes, reject it',
                cancelButtonText:'Cancel',
                preConfirm:()=>{
                    const reason=document.getElementById('swal-reject-reason').value;
                    if(!reason.trim()){Swal.showValidationMessage('Please enter a rejection reason.');return false;}
                    return reason;
                }
            }).then((result)=>{if(result.isConfirmed){submitReject(projectId,result.value);}});
        }
        function submitApprove(projectId){
            const token=document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('@Url.Action("Approve", "ProjectApproval")',{
                method:'POST',
                headers:{'Content-Type':'application/json','RequestVerificationToken':token},
                body:JSON.stringify(projectId)
            }).then(response=>{
                if(!response.ok)throw new Error('Network error');
                return response.json();
            }).then(data=>{
                if(data.success){Swal.fire("Success!","Project approved.","success").then(()=>location.reload());}
                else{Swal.fire("Error",data.message||"Failed to approve.","error");}
            }).catch(error=>{Swal.fire("Error","Request failed: "+error.message,"error");});
        }
        function submitReject(projectId,reason){
            const token=document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('@Url.Action("Reject", "ProjectApproval")',{
                method:'POST',
                headers:{'Content-Type':'application/json','RequestVerificationToken':token},
                body:JSON.stringify({Id:projectId,Reason:reason})
            }).then(response=>{
                if(!response.ok)throw new Error('Network error');
                return response.json();
            }).then(data=>{
                if(data.success){Swal.fire("Success!","Project rejected.","success").then(()=>location.reload());}
                else{Swal.fire("Error",data.message||"Failed to reject.","error");}
            }).catch(error=>{Swal.fire("Error","Request failed: "+error.message,"error");});
        }
        function exportToExcel(){
            try{
                Swal.fire({title:'Preparing Export',html:'Please wait...',allowOutsideClick:false,didOpen:()=>{Swal.showLoading();}});
                const table=document.getElementById('projectsTable');
                const clonedTable=table.cloneNode(true);
                const actionColumns=clonedTable.querySelectorAll('.no-print');
                actionColumns.forEach(col=>col.remove());
                const wb=XLSX.utils.table_to_book(clonedTable,{sheet:"Projects",raw:true});
                const today=new Date();
                const dateString=today.toISOString().split('T')[0];
                XLSX.writeFile(wb,`Projects_${dateString}.xlsx`);
                Swal.close();
            }catch(error){
                Swal.fire({title:'Export Error',text:'An error occurred while exporting: '+error.message,icon:'error'});
            }
        }
        function printTable(){
            const printSection=document.getElementById('printSection');
            if(!printSection){console.error('Print section not found');return;}
            const printWindow=window.open('','_blank');
            const printContent=printSection.innerHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,'');
            printWindow.document.write(`<head><title>Projects Report</title><style>
                body{font-family:Arial,sans-serif;padding:20px;margin:0;}
                h2{color:#333;margin-bottom:15px;}
                p{margin:5px 0;color:#555;}
                table{width:100%;border-collapse:collapse;margin-top:15px;}
                th{background:#f8f9fa;text-align:left;padding:8px;border-bottom:2px solid #ddd;}
                td{padding:8px;border-bottom:1px solid #ddd;}
                .status-badge{padding:3px 8px;border-radius:10px;font-size:12px;display:inline-block;}
                .status-pending{background:#fff3cd;color:#856404;}
                .status-approved{background:#d4edda;color:#155724;}
                .status-rejected{background:#f8d7da;color:#721c24;}
                @@media print{body{padding:0;}table{page-break-inside:auto;}tr{page-break-inside:avoid;}}
            </style></head>${printContent}`);
            printWindow.document.close();
            printWindow.onload=function(){setTimeout(()=>{printWindow.print();},200);};
        }
    </script>
}