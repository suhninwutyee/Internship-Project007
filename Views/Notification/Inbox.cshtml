@* @model List<Notification>

@{
    ViewData["Title"] = "Inbox";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}

<div class="notification-inbox">
    <div class="inbox-header">
        <h2>Notifications</h2>
        <div class="inbox-filters">
            <a asp-action="Inbox" asp-route-filter="all" class="filter-tab @(ViewBag.Filter == "all" ? "active" : "")">
                <i class="fas fa-bell"></i> All
                <span class="count-badge">@Model.Count</span>
            </a>
            <a asp-action="Inbox" asp-route-filter="unread" class="filter-tab @(ViewBag.Filter == "unread" ? "active" : "")">
                <i class="fas fa-envelope"></i> Unread
                @if (Model.Count(n => !n.IsRead) > 0)
                {
                    <span class="count-badge">@Model.Count(n => !n.IsRead)</span>
                }
            </a>
            <a asp-action="Inbox" asp-route-filter="read" class="filter-tab @(ViewBag.Filter == "read" ? "active" : "")">
                <i class="fas fa-envelope-open-text"></i> Read
            </a>
        </div>
    </div>

    <div class="notification-list">
        @if (Model.Any())
        {
            @foreach (var notification in Model)
            {
                <div class="notification-item @(notification.IsRead ? "read" : "unread")"
                     data-notification-id="@notification.NotificationId"
                     data-project-id="@notification.Project_pkId">
                    <div class="notification-icon">
                        <i class="@(notification.Message.Contains("New project") ? "fas fa-file-alt" : "fas fa-bell")"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-message">
                            @Html.Raw(notification.Message)
                        </div>
                        <div class="notification-time">
                            @notification.CreatedAt.ToString("MMM d, yyyy h:mm tt")
                        </div>
                    </div>
                    <div class="notification-actions">
                        @if (!notification.IsRead)
                        {
                            <button class="action-btn mark-read" data-id="@notification.NotificationId" title="Mark as read">
                                <i class="fas fa-check"></i>
                            </button>
                        }
                        <button class="action-btn delete-btn" data-id="@notification.NotificationId" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    @if (!notification.IsRead)
                    {
                        <span class="new-badge">NEW</span>
                    }
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="far fa-bell-slash"></i>
                <h3>No notifications found</h3>
                <p>You're all caught up!</p>
            </div>
        }
    </div>
</div>

<style>
    .notification-inbox {
        background: #f8f9fa;
        border-radius: 8px;
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
    }

    .inbox-header {
        margin-bottom: 20px;
    }

        .inbox-header h2 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 22px;
        }

    .inbox-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .filter-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: #f1f3f5;
        border-radius: 20px;
        color: #495057;
        text-decoration: none;
        font-size: 14px;
    }

        .filter-tab.active {
            background: #8C5DD1;
            color: white;
        }

    .count-badge {
        background: #ff6b6b;
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: bold;
    }

    .notification-list {
        flex: 1;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        padding: 15px;
    }

    .notification-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s;
        position: relative;
        cursor: pointer;
    }

        .notification-item.unread {
            background: #f9f6ff;
            border-left: 4px solid #8C5DD1;
        }

    .notification-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f1f3f5;
        border-radius: 50%;
        margin-right: 15px;
        color: #8C5DD1;
    }

    .notification-content {
        flex: 1;
    }

    .notification-message {
        font-size: 15px;
        color: #333;
        margin-bottom: 5px;
    }

    .notification-item.unread .notification-message {
        font-weight: 600;
    }

    .notification-time {
        font-size: 13px;
        color: #868e96;
        text-align: center;
    }

    .new-badge {
        position: absolute;
        right: 15px;
        top: 15px;
        background: #8C5DD1;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: bold;
    }

    .notification-actions {
        display: flex;
        gap: 8px;
        margin-left: 15px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: #f1f3f5;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .action-btn:hover {
            background: #e9ecef;
        }

    .mark-read:hover {
        background: #8C5DD1;
        color: white;
    }

    .delete-btn:hover {
        background: #ff4757;
        color: white;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        color: #adb5bd;
        text-align: center;
    }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #495057;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
</style>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle notification click
            $('.notification-item').click(function(e) {
                // Don't navigate if clicking on action buttons
                if ($(e.target).closest('.notification-actions').length) {
                    return;
                }

                var notificationId = $(this).data('notification-id');
                var projectId = $(this).data('project-id');
                var item = $(this);

                // Mark as read via AJAX if unread
                if (item.hasClass('unread')) {
                    $.post('/Notifications/MarkAsRead', { id: notificationId }, function(response) {
                        if (response.success) {
                            item.removeClass('unread').addClass('read');
                            item.find('.new-badge').remove();
                            item.find('.mark-read').remove();

                            // Navigate to project if exists
                            if (projectId) {
                                window.location.href = '/ProjectApproval/Details/' + projectId;
                            }
                        }
                    });
                } else {
                    // If already read, just navigate
                    if (projectId) {
                        window.location.href = '/ProjectApproval/Details/' + projectId;
                    }
                }
            });

            // Mark as read button
            $('.mark-read').click(function(e) {
                e.stopPropagation();
                var btn = $(this);
                var notificationId = btn.data('id');
                var item = btn.closest('.notification-item');

                $.post('/Notifications/MarkAsRead', { id: notificationId }, function(response) {
                    if (response.success) {
                        item.removeClass('unread').addClass('read');
                        item.find('.new-badge').remove();
                        btn.remove();
                        updateNotificationCounts();
                    }
                });
            });

            // Delete button
            $('.delete-btn').click(function(e) {
                e.stopPropagation();
                var btn = $(this);
                var notificationId = btn.data('id');
                var item = btn.closest('.notification-item');

                if (confirm('Are you sure you want to delete this notification?')) {
                    $.post('/Notifications/Delete', { id: notificationId }, function() {
                        item.fadeOut(300, function() {
                            $(this).remove();
                            updateNotificationCounts();
                        });
                    }).fail(function() {
                        alert('Failed to delete notification');
                    });
                }
            });

            // Update notification counts
            function updateNotificationCounts() {
                $.get('/Notifications/GetNotificationCount', function(unreadCount) {
                    // Update unread count
                    var unreadBadge = $('.filter-tab:nth-child(2) .count-badge');
                    if (unreadCount > 0) {
                        unreadBadge.text(unreadCount);
                    } else {
                        unreadBadge.remove();
                    }

                    // Update total count
                    var totalCount = $('.notification-item').length;
                    $('.filter-tab:nth-child(1) .count-badge').text(totalCount);
                });
            }
        });
    </script>
} *@