@model ProjectManagementSystem.ViewModels.TeacherDashboardViewModel
@using System.Text.Json
@using System.Text.Json.Serialization

@{
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
    ViewData["Title"] = "Teacher Dashboard";

    var currentHour = DateTime.Now.Hour;
    var greeting = currentHour < 12 ? "Good Morning" :
                  currentHour < 17 ? "Good Afternoon" : "Good Evening";

    // Serialize chart data
    var chartData = new
    {
        dates = Model.SubmissionStats?.Select(s => s.Date) ?? Enumerable.Empty<string>(),
        counts = Model.SubmissionStats?.Select(s => s.Count) ?? Enumerable.Empty<int>()
    };
    var serializedChartData = JsonSerializer.Serialize(chartData);
}

<div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-primary">Dashboard Overview</h1>
            <p class="text-muted mb-0">@greeting! Today is @DateTime.Now.ToString("MMMM dd, yyyy")</p>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="row mb-4 g-4">
        <!-- Total Projects -->
        <div class="col-md-4">
            <div class="stat-card" onclick="window.location.href='@Url.Action("AllProjects","Teacher")'">
                <div class="stat-icon bg-primary"><i class="bi bi-folder"></i></div>
                <h3 class="stat-title">Total Projects</h3>
                <div class="stat-value">@Model.TotalProjects</div>
            </div>
        </div>

        <!-- Pending Projects -->
        <div class="col-md-4">
            <div class="stat-card" onclick="window.location.href='@Url.Action("PendingProjects","Teacher")'">
                <div class="stat-icon bg-warning"><i class="bi bi-list-task"></i></div>
                <h3 class="stat-title">Pending Tasks</h3>
                <div class="stat-value">@Model.PendingProjectsCount</div>
            </div>
        </div>

        <!-- Announcement Card -->
        <div class="col-md-4">
            @{
                var activeAnnouncement = Model.Announcements?.FirstOrDefault();
                var isEffective = activeAnnouncement != null &&
                activeAnnouncement.IsActive &&
                DateTime.Now.Date >= activeAnnouncement.StartDate.Date &&
                (activeAnnouncement.ExpiryDate == null || DateTime.Now.Date <= activeAnnouncement.ExpiryDate.Value.Date);
            }
            <div class="stat-card announcement-card @(isEffective && activeAnnouncement?.BlocksSubmissions == true ? "border-danger" : "")">
                <div class="stat-icon @(isEffective && activeAnnouncement?.BlocksSubmissions == true ? "bg-danger" : "bg-primary")">
                    <i class="bi bi-megaphone"></i>
                </div>
                <h3 class="stat-title">Announcement</h3>

                @if (activeAnnouncement != null)
                {
                    <div class="mb-2">
                        <span class="badge @(activeAnnouncement.BlocksSubmissions ? "bg-danger" : "bg-success")">
                            @(activeAnnouncement.BlocksSubmissions ? "Submissions Blocked" : "Submissions Open")
                        </span>
                        @if (!activeAnnouncement.IsActive)
                        {
                            <span class="badge bg-secondary ms-1">Disabled</span>
                        }
                        else if (!isEffective)
                        {
                            <span class="badge bg-warning ms-1">Outside Date Range</span>
                        }
                    </div>

                    <div class="announcement-message mb-2" style="max-height:100px; overflow-y:auto;">
                        <strong>@activeAnnouncement.Title</strong>
                        <p class="mb-1 small">@activeAnnouncement.Message</p>
                    </div>

                    <small class="text-muted d-block">
                        <i class="bi bi-calendar"></i>
                        @activeAnnouncement.StartDate.ToString("MMM dd")
                        @if (activeAnnouncement.ExpiryDate.HasValue)
                        {
                            <text>- @activeAnnouncement.ExpiryDate.Value.ToString("MMM dd")</text>
                        }
                    </small>
                }
                else
                {
                    <div class="text-muted mb-2">No active announcements</div>
                }

                @if (User.IsInRole("Teacher") || User.IsInRole("Admin"))
                {
                    <div class="mt-3">
                        @if (activeAnnouncement != null)
                        {
                            <a asp-controller="Announcement" asp-action="Edit"
                               asp-route-id="@activeAnnouncement.AnnouncementId"
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> Manage
                            </a>
                        }
                        <a asp-controller="Announcement" asp-action="Create"
                           class="btn btn-sm btn-outline-success ms-2">
                            <i class="bi bi-plus"></i> Create New
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="chart-container">
                <h5>Project Submissions (Last 7 Days)</h5>
                <div style="height:300px;">
                    <canvas id="submissionsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Submissions -->
    <div class="row">
        <div class="col-12">
            <div class="activity-card">
                <div class="card-header">Recent Submissions</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Student</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.RecentSubmitters?.Any() == true)
                                {
                                    @foreach (var submission in Model.RecentSubmitters)
                                    {
                                        <tr>
                                            <td>@submission.ProjectName</td>
                                            <td>@submission.StudentName</td>
                                            <td>@submission.SubmissionDate.ToString("yyyy-MM-dd")</td>
                                            <td><span class="badge badge-custom">Submitted</span></td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center">No recent submissions</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartData = @Html.Raw(serializedChartData);
        const ctx = document.getElementById('submissionsChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.dates.map(date => {
                    const [year, month, day] = date.split('-');
                    const d = new Date(year, month-1, day);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Submissions',
                    data: chartData.counts,
                    borderColor: '#8C5DD1',
                    backgroundColor: 'rgba(140, 93, 209, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: '#8C5DD1',
                    pointBorderColor: '#fff',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return `${ctx.parsed.y} submission${ctx.parsed.y !== 1 ? 's' : ''}`;
                            },
                            title: function(ctx) {
                                const dateStr = chartData.dates[ctx[0].dataIndex];
                                const [y, m, d] = dateStr.split('-');
                                return new Date(y, m-1, d).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero:true, grid:{color:'rgba(0,0,0,0.05)'}, ticks:{stepSize:1, precision:0} },
                    x: { grid:{display:false} }
                },
                onClick: function(evt, elems) {
                    if(elems.length>0){
                        const index = elems[0].index;
                        const dateStr = chartData.dates[index];
                        window.location.href = `@Url.Action("ProjectsByDate", "Teacher")?date=${dateStr}`;
                    }
                }
            }
        });

        document.getElementById('submissionsChart').style.cursor = 'pointer';
    });
</script>
