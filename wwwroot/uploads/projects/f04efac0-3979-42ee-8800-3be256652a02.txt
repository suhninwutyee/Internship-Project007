using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using ProjectManagementSystem.Data;
using ProjectManagementSystem.Models;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using X.PagedList;

namespace ProjectManagementSystem.Controllers
{
    public class ProjectController : Controller
    {
        private readonly ApplicationDbContext _context;
        private readonly IWebHostEnvironment _env;
        private readonly ILogger<ProjectController> _logger;

        public ProjectController(ApplicationDbContext context, IWebHostEnvironment env, ILogger<ProjectController> logger)
        {
            _context = context;           
            _env = env;
            _logger = logger;

        }

        public async Task<IActionResult> Index(int page = 1)
        {
            int pageSize = 3;

            var projects = _context.Projects
     .Include(p => p.ProjectType)
     .Include(p => p.Language)
     .Include(p => p.Framework)
     .Include(p => p.Company)
     .Include(p => p.Files)
     .Include(p => p.ProjectMembers)
         .ThenInclude(pm => pm.Student)
     .OrderByDescending(p => p.ProjectSubmittedDate);


            var pagedProjects = await projects.ToPagedListAsync(page, pageSize);

            return View(pagedProjects);
        }


        // GET: Project/Upload/5
        public async Task<IActionResult> Upload(int id)
        {
            var project = await _context.Projects
                .Include(p => p.ProjectType)
                .Include(p => p.Language)
                .Include(p => p.Framework)
                .Include(p => p.Company)
                .Include(p => p.Files)
                .Include(p => p.ProjectMembers)
                    .ThenInclude(pm => pm.Student)
                .FirstOrDefaultAsync(p => p.Project_pkId == id);

            if (project == null)
                return NotFound();

            if (project.Status == "Pending" || project.Status == "Approved")
            {
                TempData["UploadError"] = "You cannot upload again because the project is already submitted or approved.";
                return RedirectToAction(nameof(Index));
            }

            return View(project);
        }

        //// POST: Project/Upload
        //[HttpPost]
        //[ValidateAntiForgeryToken]
        //public async Task<IActionResult> Upload(Project project)
        //{
        //    var existingProject = await _context.Projects.FindAsync(project.Project_pkId);
        //    if (existingProject == null)
        //        return NotFound();

        //    // Prevent multiple uploads when status is Pending or Approved
        //    if (existingProject.Status == "Pending" || existingProject.Status == "Approved")
        //    {
        //        TempData["Error"] = "You cannot upload again. Wait for teacher feedback.";
        //        return RedirectToAction(nameof(Index));
        //    }

        //    // Mark project as submitted to teacher
        //    existingProject.Status = "Pending";
        //    existingProject.ProjectSubmittedDate = DateTime.Now;

        //    await _context.SaveChangesAsync();

        //    TempData["UploadSuccess"] = "Project successfully uploaded and sent to teacher.";
        //    return RedirectToAction(nameof(Index));
        //}


        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Upload(Project project)
        {
            var existingProject = await _context.Projects
                .Include(p => p.Language)
                .Include(p => p.ProjectType)
                .Include(p => p.Framework)
                .Include(p => p.Company)
                .Include(p => p.ProjectMembers)
                    .ThenInclude(pm => pm.Student)
                .FirstOrDefaultAsync(p => p.Project_pkId == project.Project_pkId);

            if (existingProject == null)
                return NotFound();

            // Prevent multiple uploads
            if (existingProject.Status == "Pending" || existingProject.Status == "Approved")
            {
                TempData["Error"] = "You cannot upload again. Wait for teacher feedback.";
                return RedirectToAction(nameof(Index));
            }

            // Mark project as submitted
            existingProject.Status = "Pending";
            existingProject.ProjectSubmittedDate = DateTime.Now;

            await _context.SaveChangesAsync();

            TempData["UploadSuccess"] = "Project successfully uploaded and sent to teacher.";
            return RedirectToAction(nameof(Index));
        }


        public async Task<IActionResult> Details(int? id)
        {
            if (id == null) return NotFound();

            var project = await _context.Projects
                .Include(p => p.ProjectType)
                .Include(p => p.Language)
                .Include(p => p.Framework)
                .Include(p => p.Company)
                .Include(p => p.ProjectMembers)
                    .ThenInclude(pm => pm.Student) // ✅ Include Student data for each ProjectMember
                .FirstOrDefaultAsync(m => m.Project_pkId == id);

            if (project == null) return NotFound();

            return View(project);
        }



        // GET: Project/AddMember/5
        [HttpGet]
        public IActionResult AddMember(int projectId)
        {
            var model = new AddMemberViewModel
            {
                ProjectId = projectId
            };

            return View(model);
        }

        // POST: Project/AddMember
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> AddMember(AddMemberViewModel model)
        {
            if (ModelState.IsValid)
                return View(model);

            // Find student by RollNumber and EmailAddress
            var student = await _context.Students
                .Include(s => s.Email)
                .FirstOrDefaultAsync(s =>
                    s.Email.RollNumber == model.RollNumber &&
                    s.Email.EmailAddress == model.EmailAddress);

            if (student == null)
            {
                ModelState.AddModelError(string.Empty, "Student not found. Please check Roll Number and Email.");
                return View(model);
            }

            // Check if already added
            bool alreadyAdded = await _context.ProjectMembers
                .AnyAsync(pm => pm.Student_pkId == student.Student_pkId && pm.Project_pkId == model.ProjectId);

            if (alreadyAdded)
            {
                ModelState.AddModelError(string.Empty, "This student is already added to the project.");
                return View(model);
            }

            // Add member
            var newMember = new ProjectMember
            {
                Student_pkId = student.Student_pkId,
                Project_pkId = model.ProjectId,
                Role = "Member",
                IsDeleted = false
            };

            _context.ProjectMembers.Add(newMember);
            await _context.SaveChangesAsync();

            TempData["Success"] = "Team member added successfully.";
            return RedirectToAction("Dashboard", "Student");
        }
        public async Task<IActionResult> RemoveMember(int id)
        {
            var member = await _context.ProjectMembers.FindAsync(id);
            if (member != null)
            {
                _context.ProjectMembers.Remove(member);
                await _context.SaveChangesAsync();
                TempData["Success"] = "Member removed.";
            }
            return RedirectToAction("Dashboard", "Student");
        }


        public IActionResult Create()
        {
            LoadDropdownData();
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Create(Project project, string CompanyAddress, string CompanyContact, string CompanyDescription, int? CompanyCity_pkId, IFormFile CompanyPhoto, List<IFormFile> projectFiles)
        {
            if (ModelState.IsValid)  // <-- FIXED: Run only if model is valid
            {
                project.Status = "Draft"; // Set initial status to Draft
                project.ProjectSubmittedDate = null;

                // Update company details if company is selected
                if (project.Company_pkId != null && project.Company_pkId != 0)
                {
                    var company = await _context.Companies.FindAsync(project.Company_pkId);
                    if (company != null)
                    {
                        company.Address = CompanyAddress;
                        company.Contact = CompanyContact;
                        company.Description = CompanyDescription;
                        company.City_pkId = CompanyCity_pkId;

                        if (CompanyPhoto != null && CompanyPhoto.Length > 0)
                        {
                            var companyFolder = Path.Combine(_env.WebRootPath, "images", "companies");
                            Directory.CreateDirectory(companyFolder);

                            var uniqueCompanyFileName = $"{Guid.NewGuid()}{Path.GetExtension(CompanyPhoto.FileName)}";
                            var companyFilePath = Path.Combine(companyFolder, uniqueCompanyFileName);

                            using (var stream = new FileStream(companyFilePath, FileMode.Create))
                            {
                                await CompanyPhoto.CopyToAsync(stream);
                            }

                            company.ImageFileName = uniqueCompanyFileName;
                        }

                        _context.Companies.Update(company);
                    }
                }

                // Save project to get Project_pkId
                _context.Projects.Add(project);
                await _context.SaveChangesAsync();

                // Add logged-in student as Leader in ProjectMembers
                var rollNumber = HttpContext.Session.GetString("RollNumber");
                if (!string.IsNullOrEmpty(rollNumber))
                {
                    var student = await _context.Students
                        .Include(s => s.Email)
                        .FirstOrDefaultAsync(s => s.Email.RollNumber == rollNumber && !s.IsDeleted);

                    if (student != null)
                    {
                        var projectMember = new ProjectMember
                        {
                            Student_pkId = student.Student_pkId,
                            Project_pkId = project.Project_pkId,
                            Role = "Leader",
                            IsDeleted = false
                        };

                        _context.ProjectMembers.Add(projectMember);
                        await _context.SaveChangesAsync();
                    }
                }

                // Save project files
                if (projectFiles != null && projectFiles.Count > 0)
                {
                    var uploadsFolder = Path.Combine(_env.WebRootPath, "uploads", "projects");
                    Directory.CreateDirectory(uploadsFolder);

                    foreach (var file in projectFiles)
                    {
                        if (file.Length > 0)
                        {
                            var uniqueFileName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
                            var filePath = Path.Combine(uploadsFolder, uniqueFileName);

                            using (var stream = new FileStream(filePath, FileMode.Create))
                            {
                                await file.CopyToAsync(stream);
                            }

                            var projectFile = new ProjectFile
                            {
                                Project_pkId = project.Project_pkId,
                                FilePath = $"/uploads/projects/{uniqueFileName}",
                                FileType = Path.GetExtension(file.FileName)
                            };

                            _context.ProjectFiles.Add(projectFile);
                        }
                    }

                    await _context.SaveChangesAsync();
                }

                return RedirectToAction("Dashboard", "Student");
            }
            else
            {
                LoadDropdownData(project);
                return View(project);
            }
        }




        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Edit(
    int id,
    Project project,
    string CompanyAddress,
    string CompanyContact,
    string CompanyDescription,
    int? CompanyCity_pkId,
    IFormFile CompanyPhoto,
    List<IFormFile> projectFiles)
        {
            if (id != project.Project_pkId)
                return NotFound();

            var existingProject = await _context.Projects.AsNoTracking().FirstOrDefaultAsync(p => p.Project_pkId == id);
            if (existingProject == null)
                return NotFound();

            if (existingProject.Status == "Pending" || existingProject.Status == "Approved")
            {
                TempData["Error"] = "You cannot edit a project that is pending or approved. Wait for teacher feedback.";
                return RedirectToAction(nameof(Index));
            }

            if (!ModelState.IsValid)
            {
                LoadDropdownData(project);
                return View(project);
            }

            try
            {
                // Update company info
                if (project.Company_pkId != 0)
                {
                    var company = await _context.Companies.FindAsync(project.Company_pkId);
                    if (company != null)
                    {
                        company.Address = CompanyAddress;
                        company.Contact = CompanyContact;
                        company.Description = CompanyDescription;
                        company.City_pkId = CompanyCity_pkId;

                        if (CompanyPhoto != null && CompanyPhoto.Length > 0)
                        {
                            var uploadsFolder = Path.Combine(_env.WebRootPath, "images", "companies");
                            Directory.CreateDirectory(uploadsFolder);

                            var uniqueFileName = $"{Guid.NewGuid()}{Path.GetExtension(CompanyPhoto.FileName)}";
                            var filePath = Path.Combine(uploadsFolder, uniqueFileName);

                            using (var stream = new FileStream(filePath, FileMode.Create))
                            {
                                await CompanyPhoto.CopyToAsync(stream);
                            }

                            company.ImageFileName = uniqueFileName;
                        }

                        _context.Companies.Update(company);
                    }
                }

                _context.Projects.Update(project);
                await _context.SaveChangesAsync();

                // Save new project files
                if (projectFiles != null && projectFiles.Count > 0)
                {
                    var uploadPath = Path.Combine(_env.WebRootPath, "uploads", "projects");
                    Directory.CreateDirectory(uploadPath);

                    foreach (var file in projectFiles)
                    {
                        if (file.Length > 0)
                        {
                            var uniqueFileName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
                            var filePath = Path.Combine(uploadPath, uniqueFileName);

                            using (var stream = new FileStream(filePath, FileMode.Create))
                            {
                                await file.CopyToAsync(stream);
                            }

                            var projectFile = new ProjectFile
                            {
                                Project_pkId = project.Project_pkId,
                                FilePath = $"/uploads/projects/{uniqueFileName}",
                                FileType = Path.GetExtension(file.FileName) // REQUIRED if not nullable
                            };

                            _context.ProjectFiles.Add(projectFile);
                        }
                    }

                    await _context.SaveChangesAsync();
                }

                return RedirectToAction(nameof(Index));
            }
            catch (DbUpdateConcurrencyException)
            {
                if (!_context.Projects.Any(e => e.Project_pkId == project.Project_pkId))
                    return NotFound();
                else
                    throw;
            }
        }





        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Delete(int id)
        {
            var project = await _context.Projects.FindAsync(id);
            if (project == null)
                return NotFound();

            if (project.Status == "Pending" || project.Status == "Approved")
            {
                TempData["Error"] = "You cannot delete a project that is pending or approved. Wait for teacher feedback.";
                return RedirectToAction(nameof(Index));
            }

            _context.Projects.Remove(project);
            await _context.SaveChangesAsync();

            return RedirectToAction(nameof(Index));
        }

        [HttpGet]
        public async Task<IActionResult> DeleteProjectFile(int id)
        {
            var file = await _context.ProjectFiles.FindAsync(id);
            if (file == null)
                return NotFound();

            // Delete file from disk
            var filePath = Path.Combine(_env.WebRootPath, file.FilePath.TrimStart('/'));
            if (System.IO.File.Exists(filePath))
            {
                System.IO.File.Delete(filePath);
            }

            // Remove from DB
            _context.ProjectFiles.Remove(file);
            await _context.SaveChangesAsync();

            // Redirect to Edit page of the associated project
            return RedirectToAction("Edit", new { id = file.Project_pkId });
        }

        [HttpGet]
        public JsonResult GetFrameworksByLanguage(int languageId)
        {
            var frameworks = _context.Frameworks
                .Where(f => f.Language_pkId == languageId)
                .OrderBy(f => f.FrameworkName)
                .Select(f => new
                {
                    framework_pkId = f.Framework_pkId,
                    frameworkName = f.FrameworkName
                })
                .ToList();

            return Json(frameworks);
        }

        [HttpGet]
        public async Task<JsonResult> GetCompanyInfo(int companyId)
        {
            var company = await _context.Companies.FindAsync(companyId);
            if (company == null) return Json(null);

            return Json(new
            {
                address = company.Address,
                contact = company.Contact,
                description = company.Description,
                city_pkId = company.City_pkId,
                imageFileName = company.ImageFileName
            });
        }

        private void LoadDropdownData(Project? selectedProject = null)
        {
            ViewBag.ProjectTypes = new SelectList(
                _context.ProjectTypes.OrderBy(p => p.TypeName),
                "ProjectType_pkId", "TypeName", selectedProject?.ProjectType_pkId
            );

            ViewBag.Languages = new SelectList(
                _context.Languages.OrderBy(l => l.LanguageName),
                "Language_pkId", "LanguageName", selectedProject?.Language_pkId
            );

            ViewBag.Frameworks = new SelectList(
                _context.Frameworks.OrderBy(f => f.FrameworkName),
                "Framework_pkId", "FrameworkName", selectedProject?.Framework_pkId
            );

            var companies = _context.Companies
                .Where(c => c.CompanyName != null)
                .ToList();

            ViewBag.Companies = new SelectList(
                companies, "Company_pkId", "CompanyName", selectedProject?.Company_pkId
            );

            ViewBag.CityList = new SelectList(
                _context.Cities.OrderBy(c => c.CityName),
                "City_pkId", "CityName"
            );
        }
    }
}
    

Index
@model X.PagedList.IPagedList<ProjectManagementSystem.Models.Project>

@{
    ViewData["Title"] = "Project List";
    int count = (Model.PageNumber - 1) * Model.PageSize + 1;
    var total = Model.TotalItemCount;
    Layout = "_Layout";
}
@if (TempData["UploadSuccess"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["UploadSuccess"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}



<div class="container my-4" style="max-width: 1100px;">
    <h3 class="mb-4" style="color: #8c5dd1;">Project List</h3>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <a asp-action="Create" class="btn btn-primary shadow-sm" style="background-color: #8c5dd1; border-color: #8c5dd1;">
            <i class="bi bi-plus-lg me-1"></i> Create New Project
        </a>
        <span class="fw-semibold" style="color: #8c5dd1;">Total Projects: @total</span>
    </div>

    @if (Model.Any())
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var project in Model)
            {
                <div class="col">
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-body">
                            <h5 class="card-title text-primary">@project.ProjectName</h5>

                            <p class="card-text mb-1"><strong>Supervisor:</strong> @project.SupervisorName</p>
                            <p class="card-text mb-1"><strong>Type:</strong> @project.ProjectType?.TypeName</p>
                            <p class="card-text mb-1"><strong>Language:</strong> @project.Language?.LanguageName</p>
                            <p class="card-text mb-1"><strong>Framework:</strong> @project.Framework?.FrameworkName</p>
                            <p class="card-text mb-1"><strong>Company:</strong> @project.Company?.CompanyName</p>
                            <p class="card-text mb-1">
                                <strong>Leader:</strong>
                                @{
                                    var leader = project.ProjectMembers?
                                    .FirstOrDefault(m => m.Role == "Leader" && !m.IsDeleted && m.Student != null);

                                    if (leader != null)
                                    {
                                        <span class="d-block">
                                            @leader.Student?.StudentName (@leader.Student?.Student_pkId)
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No leader assigned</span>
                                    }
                                }
                            </p>

                            <p class="card-text mb-1">
                                <strong>Members:</strong>
                                @{
                                    var members = project.ProjectMembers?
                                    .Where(m => m.Role == "Member" && !m.IsDeleted && m.Student != null)
                                    .ToList();

                                    if (members != null && members.Any())
                                    {
                                        foreach (var member in members)
                                        {
                                            <span class="d-block">
                                                @member.Student?.StudentName (@member.Student?.Student_pkId)
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">No members</span>
                                    }
                                }
                            </p>

                            <p class="card-text mb-1">
                                <strong>Date:</strong> @(project.ProjectSubmittedDate.HasValue
                        ? project.ProjectSubmittedDate.Value.ToShortDateString()
                        : "Not submitted")
                            </p>

                            <p class="card-text mb-2">
                                <strong>Files:</strong><br />
                                @if (project.Files != null && project.Files.Any())
                                {
                                    foreach (var file in project.Files)
                                    {
                                        <a href="@file.FilePath" target="_blank" class="text-decoration-none text-primary d-block">
                                            <i class="bi bi-paperclip"></i> @System.IO.Path.GetFileName(file.FilePath)
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No files</span>
                                }
                            </p>
                            <p class="card-text mb-1">
                                <strong>Status:</strong>
                                @{
                                    var statusClass = project.Status switch
                                    {
                                        "Pending" => "bg-warning text-dark",
                                        "Approved" => "bg-success",
                                        "Rejected" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @statusClass">@project.Status</span>
                            </p>                           
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="d-flex flex-wrap gap-1">
                                @if (project.Status == "Draft")
                                {
                                    <form asp-action="Upload" method="post" onsubmit="return confirm('Are you sure you want to upload the project?');" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="Project_pkId" value="@project.Project_pkId" />
                                        <button type="submit" class="btn btn-sm btn-outline-primary ms-1">
                                            <i class="bi bi-upload"></i> Upload
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary ms-1" disabled title="You can’t upload again. Wait for teacher’s feedback.">
                                        <i class="bi bi-clock"></i> Awaiting Review
                                    </button>
                                }


                                @if (project.Status == "Draft")
                                {
                                    <a asp-action="Edit" asp-route-id="@project.Project_pkId" class="btn btn-sm btn-outline-warning">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary" disabled title="Editing is disabled once submitted.">
                                        <i class="bi bi-lock-fill"></i>
                                    </button>
                                }

                                <form asp-action="Delete" asp-route-id="@project.Project_pkId" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this project?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </form>
                                <a asp-action="Details" asp-route-id="@project.Project_pkId" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-info-circle-fill"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                count++;
            }
        </div>
    }
    else
    {
        <div class="text-center text-muted py-4">No projects found.</div>
    }

    <div class="d-flex justify-content-center mt-4">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page }), new X.PagedList.Web.Common.PagedListRenderOptions
   {
       UlElementClasses = new[] { "pagination", "pagination-sm" },
       LiElementClasses = new[] { "page-item" },
       PageClasses = new[] { "page-link" },
       ActiveLiElementClass = "active",
       LinkToPreviousPageFormat = "«",
       LinkToNextPageFormat = "»"
   })
    </div>
</div>

@section Styles {
    <style>
        ul.pagination {
            display: flex;
            flex-wrap: wrap;
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }

            ul.pagination li {
                margin: 3px;
            }

                ul.pagination li a,
                ul.pagination li span {
                    display: block;
                    padding: 0.375rem 0.75rem;
                    color: #8c5dd1;
                    text-decoration: none;
                    border: 1px solid #8c5dd1;
                    border-radius: 0.25rem;
                    transition: background-color 0.2s, color 0.2s;
                }

                    ul.pagination li a:hover:not(.disabled) {
                        background-color: #8c5dd1;
                        color: white;
                        border-color: #8c5dd1;
                    }

                ul.pagination li.active span {
                    background-color: #8c5dd1;
                    color: white;
                    border-color: #8c5dd1;
                }

                ul.pagination li.disabled span {
                    color: #6c757d;
                    border-color: #dee2e6;
                }
    </style>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
}




Detail
@model ProjectManagementSystem.Models.Project

@{
    ViewData["Title"] = "Project Details";
    Layout = "_Layout";
}

<style>
    .custom-details-card {
        max-width: 900px;
        margin: 0 auto;
        border-radius: 16px;
    }

    .custom-card-header {
        background-color: #8c5dd1; /* Change this to your project color */
        color: white;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        padding: 16px;
    }

    .custom-table th {
        width: 30%;
        background-color: #f1f1f1;
    }

    .custom-table td {
        background-color: #fff;
    }

    .back-button {
        margin-top: 20px;
    }
</style>

<div class="card custom-details-card shadow">
    <div class="custom-card-header">
        <h4 class="mb-0">Project Details</h4>
    </div>
    <div class="card-body p-4">
        <table class="table table-bordered custom-table">
            <tr>
                <th>Project Name</th>
                <td>@Model.ProjectName</td>
            </tr>
            <tr>
                <th>Supervisor</th>
                <td>@Model.SupervisorName</td>
            </tr>
            <tr>
                <th>Project Type</th>
                <td>@Model.ProjectType?.TypeName</td>
            </tr>
            <tr>
                <th>Language</th>
                <td>@Model.Language?.LanguageName</td>
            </tr>
            <tr>
                <th>Framework</th>
                <td>@Model.Framework?.FrameworkName</td>
            </tr>
            <tr>
                <th>Company</th>
                <td>@Model.Company?.CompanyName</td>
            </tr>

            <tr>
                <th>Leader</th>
                <td>
                    @{
                        var leader = Model.ProjectMembers?
                        .FirstOrDefault(pm => pm.Role == "Leader" && !pm.IsDeleted && pm.Student != null);
                        if (leader != null)
                        {
                            <span>@leader.Student.StudentName (@leader.Student.Student_pkId)</span>
                        }
                        else
                        {
                            <span class="text-muted">No leader assigned</span>
                        }
                    }
                </td>
            </tr>

            <tr>
                <th>Members</th>
                <td>
                    @{
                        var members = Model.ProjectMembers?
                        .Where(pm => pm.Role == "Member" && !pm.IsDeleted && pm.Student != null)
                        .ToList();
                        if (members != null && members.Any())
                        {
                            foreach (var member in members)
                            {
                                <div>@member.Student.StudentName (@member.Student.Student_pkId)</div>
                            }
                        }
                        else
                        {
                            <span class="text-muted">No members assigned</span>
                        }
                    }
                </td>
            </tr>


            <tr>
                <th>Submitted Date</th>
                @(Model.ProjectSubmittedDate.HasValue ? Model.ProjectSubmittedDate.Value.ToShortDateString() : "Not submitted")

            </tr>
            <tr>
                <th>Created By</th>
                <td>@Model.CreatedBy</td>
            </tr>

            <tr>
                <th>Status</th>
                <td>
                    @switch (Model.Status)
                    {
                        case "Approved":
                            <span class="badge bg-success">Approved</span>
                            break;
                        case "Rejected":
                            <span class="badge bg-danger">Rejected</span>
                            break;
                        case "Pending":
                            <span class="badge bg-warning text-dark">Pending</span>
                            break;
                        default:
                            <span class="badge bg-secondary">@Model.Status</span>
                            break;
                    }
                </td>
            </tr>


        </table>
        @if (Model.Status == "Rejected" && !string.IsNullOrWhiteSpace(Model.AdminComment))
        {
            <div class="alert alert-danger mt-4">
                <strong>Rejection Reason:</strong> @Model.AdminComment
            </div>
        }

        <div class="back-button text-end">
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
</div>
 

ProjectApproval
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using ProjectManagementSystem.Data;
using ProjectManagementSystem.Models;

namespace ProjectManagementSystem.Controllers
{
    public class ProjectApprovalController : Controller
    {
        private readonly ApplicationDbContext _context;

        public ProjectApprovalController(ApplicationDbContext context)
        {
            _context = context;
        }

        public async Task<IActionResult> Index(string statusFilter = "all", string searchString = "", int pageNumber = 1)
        {
            int pageSize = 3; // Items per page

            var query = _context.Projects
                .Include(p => p.Company)
                .Include(p => p.ProjectType)
                .Include(p => p.ProjectMembers)
                    .ThenInclude(pm => pm.Student)
                .Where(p => p.IsDeleted == null || p.IsDeleted == false);

            // Apply search filter
            if (!string.IsNullOrEmpty(searchString))
            {
                query = query.Where(p =>
                    p.ProjectName.Contains(searchString) ||
                    p.CreatedBy.Contains(searchString) 
                    //p.ProjectMembers.Any(pm => pm.Student.StudentName.Contains(searchString))
                );
            }

            // Apply status filter
            if (statusFilter != "all")
            {
                query = query.Where(p => p.Status == statusFilter);
            }

            // Get counts and paginated results
            var totalCount = await query.CountAsync();
            var projects = await query
                .OrderByDescending(p => p.ProjectSubmittedDate)
                .Skip((pageNumber - 1) * pageSize)
                .Take(pageSize)
                .ToListAsync();

            // Set ViewBag values
            ViewBag.TotalCount = await _context.Projects.CountAsync(p => p.IsDeleted == null || p.IsDeleted == false);
            ViewBag.PendingCount = await _context.Projects.CountAsync(p => p.Status == "Pending" && (p.IsDeleted == null || p.IsDeleted == false));
            ViewBag.ApprovedCount = await _context.Projects.CountAsync(p => p.Status == "Approved" && (p.IsDeleted == null || p.IsDeleted == false));
            ViewBag.RejectedCount = await _context.Projects.CountAsync(p => p.Status == "Rejected" && (p.IsDeleted == null || p.IsDeleted == false));
            ViewBag.CurrentFilter = statusFilter;
            ViewBag.SearchString = searchString;
            ViewBag.PageNumber = pageNumber;
            ViewBag.TotalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
            ViewBag.PageTitle = statusFilter == "all" ? "All Projects" : $"{statusFilter} Projects";

            return View(projects);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Approve([FromBody] int id)
        {
            var project = await _context.Projects.FindAsync(id);
            if (project == null)
                return Json(new { success = false, message = "Project not found." });

            project.Status = "Approved";
            project.ApprovedDate = DateTime.Now;
            project.AdminComment = null;

            await _context.SaveChangesAsync();
            return Json(new { success = true });
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> Reject([FromBody] RejectModel model)
        {
            var project = await _context.Projects.FindAsync(model.Id);
            if (project == null)
                return Json(new { success = false, message = "Project not found." });

            if (string.IsNullOrWhiteSpace(model.Reason))
                return Json(new { success = false, message = "Rejection reason is required." });

            project.Status = "Rejected";
            project.AdminComment = model.Reason;
            project.ApprovedDate = null;

            await _context.SaveChangesAsync();
            return Json(new { success = true });
        }

        public async Task<IActionResult> Details(int id)
        {
            var project = await _context.Projects
        .Include(p => p.Company)
        .Include(p => p.ProjectType)
        .Include(p => p.Language)
        .Include(p => p.Framework)
        .Include(p => p.Files)
        .Include(p => p.ProjectMembers)
            .ThenInclude(pm => pm.Student) // Include Student data
        .FirstOrDefaultAsync(p => p.Project_pkId == id);

            if (project == null)
            {
                return NotFound();
            }

            ViewBag.IsPending = project.Status == "Pending";
            ViewBag.StatusMessage = TempData["StatusMessage"];
            ViewBag.IsSuccess = TempData["IsSuccess"];

            return View(project);
        }

        public class RejectModel
        {
            public int Id { get; set; }
            public string Reason { get; set; }
        }

    }
}


Index

@model IEnumerable<ProjectManagementSystem.Models.Project>
@{
    ViewData["Title"] = ViewBag.PageTitle;
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
}

<head>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<style>

    

    

    .search-container {
        background: #E4EEFD;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    /* Approval-page filter buttons */
    .filter-buttons {
        margin: 16px 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn {
        background: #fff;
        border: 1px solid var(--accent);
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 14px;
        color: var(--accent);
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }

        .filter-btn:hover {
            background: var(--accent);
            color: #fff;
        }

        .filter-btn.active {
            background: var(--accent);
            color: #fff;
        }

    /* Section wrapper */
    .approval-section {
        margin-top: 20px;
    }

        .approval-section h2 {
            margin-bottom: 12px;
            font-size: 20px;
            color: #333;
        }

    /* Responsive container */
    .table-container {
        overflow-x: auto;
    }

    /* Table base styles */
    .approval-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

        .approval-table th,
        .approval-table td {
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }

        .approval-table thead th {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .approval-table tbody tr:nth-child(even) td {
            background: #f9f9f9;
        }

        .approval-table tbody tr:hover td {
            background: #f1f1f1;
        }

        /* Status styling */
        .approval-table td.status {
            font-weight: 600;
        }

    .status-approved {
        color: #28a745;
    }

    .status-rejected {
        color: #dc3545;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background 0.2s;
        position: relative;
    }

        .btn-icon:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-icon.approve {
            color: #28a745;
        }

        .btn-icon.reject {
            color: #dc3545;
        }

        .btn-icon.view {
            color: #007bff;
        }

        .btn-icon[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon .tooltip {
            visibility: hidden;
            width: 80px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

    /* Project name wrapping */
    .project-name {
        max-width: 200px;
        word-wrap: break-word;
    }

    /* SweetAlert customization */
    .swal2-popup {
        border-radius: 8px !important;
    }

    .swal2-title {
        font-size: 1.2rem !important;
    }

    .swal2-content {
        font-size: 1rem !important;
    }

    .swal2-textarea {
        min-height: 100px;
        margin-top: 10px;
        border-radius: 4px;
        padding: 10px;
    }

    .custom-swal-popup {
        border-radius: 12px !important;
        border: 1px solid #C8C6C1;
        width: 500px; /* Medium size */
        max-width: 80%;
    }

    .custom-swal-title {
        color: #8C5DD1;
        font-size: 1.4rem !important;
        font-weight: 600;
    }

    .custom-swal-content {
        color: #333;
        font-size: 1rem !important;
    }

    .custom-swal-confirm-btn {
        background-color: #8C5DD1 !important;
        border-radius: 6px !important;
        padding: 8px 20px !important;
        font-weight: 500;
    }

    .custom-swal-cancel-btn {
        background-color: #C8C6C1 !important;
        border-radius: 6px !important;
        padding: 8px 20px !important;
        font-weight: 500;
        color: #333 !important;
    }

    .swal2-textarea {
        border-radius: 6px !important;
        border: 1px solid #C8C6C1 !important;
        background: white !important;
        color: #333 !important;
    }

    .swal2-icon {
        color: #8C5DD1 !important;
        border-color: #8C5DD1 !important;
    }

    /* Header styling */
    .page-header {
        margin-bottom: 1.5rem;
    }

    .main-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #8C5DD1;
        margin-bottom: 0.5rem;
    }

    .sub-title {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    /* Search and filter container */
    .search-filter-container {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Search box styling */
    .search-box {
        flex-grow: 1;
        min-width: 250px;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 0.5rem 1rem;
        padding-right: 2.5rem;
        border: 1px solid #C8C6C1;
        border-radius: 20px;
        background: #E4EEFD;
        transition: all 0.3s;
    }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(140, 93, 209, 0.2);
        }

    .search-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #8C5DD1;
        cursor: pointer;
    }

    /* Filter buttons */
    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        background: white;
        border: 1px solid #8C5DD1;
        border-radius: 20px;
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
        color: #8C5DD1;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }

        .filter-btn:hover {
            background: #8C5DD1;
            color: white;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #8C5DD1;
            color: white;
            box-shadow: 0 2px 6px rgba(140, 93, 209, 0.3);
        }

    /* Table styling (keep your existing table styles) */
    .approval-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    /* ... (keep all your existing table styles) ... */

    /* Status badges */
    .status-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        display: inline-block;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .pagination {
        display: flex;
        gap: 0.5rem;
        list-style: none;
        padding: 0;
    }

    .page-link {
        color: #8C5DD1;
        background: white;
        border: 1px solid #C8C6C1;
        padding: 0.5rem 0.9rem;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.3s;
    }

        .page-link:hover {
            background: #E4EEFD;
            border-color: #8C5DD1;
        }

    .page-item.active .page-link {
        background: #8C5DD1;
        color: white;
        border-color: #8C5DD1;
    }

    .page-item.disabled .page-link {
        color: #C8C6C1;
        pointer-events: none;
    }

    /* Project name wrapping */
    .project-name {
        max-width: 200px;
        word-wrap: break-word;
    }

    /* SweetAlert customization */
    .swal2-popup {
        border-radius: 8px !important;
    }
</style>

<div class="container mt-3">
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="main-title">Submitted Projects</h2>
        <p class="sub-title">@ViewBag.PageTitle</p>
    </div>

    <!-- Search and Filter Container -->
    <div class="search-filter-container">
        

        <!-- Filter Buttons -->
        <div class="filter-buttons">
            <button class="filter-btn @(ViewBag.CurrentFilter == "all" ? "active" : "")"
                    onclick="window.location.href='@Url.Action("Index", new { statusFilter = "all", searchString = ViewBag.SearchString })'">
                All (@ViewBag.TotalCount)
            </button>
            <button class="filter-btn @(ViewBag.CurrentFilter == "Pending" ? "active" : "")"
                    onclick="window.location.href='@Url.Action("Index", new { statusFilter = "Pending", searchString = ViewBag.SearchString })'">
                Pending (@ViewBag.PendingCount)
            </button>
            <button class="filter-btn @(ViewBag.CurrentFilter == "Approved" ? "active" : "")"
                    onclick="window.location.href='@Url.Action("Index", new { statusFilter = "Approved", searchString = ViewBag.SearchString })'">
                Approved (@ViewBag.ApprovedCount)
            </button>
            <button class="filter-btn @(ViewBag.CurrentFilter == "Rejected" ? "active" : "")"
                    onclick="window.location.href='@Url.Action("Index", new { statusFilter = "Rejected", searchString = ViewBag.SearchString })'">
                Rejected (@ViewBag.RejectedCount)
            </button>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <form asp-action="Index" method="get">
                <input type="text" class="search-input" name="searchString" value="@ViewBag.SearchString"
                       placeholder="Search projects...">
                <input type="hidden" name="statusFilter" value="@ViewBag.CurrentFilter" />
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Projects Table -->
    <div class="table-responsive">
        <table class="approval-table">
            <!-- Table content remains the same -->
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Project Name</th>
                    <th>Student Name</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int counter = (ViewBag.PageNumber - 1)  + 1;
                }
                @foreach (var project in Model)
                {
                    <tr>
                        <td>@(counter++)</td>
                        <td class="project-name">@project.ProjectName</td>
                        @{
                            var leader = project.ProjectMembers.FirstOrDefault(m => m.Role == "Leader");
                        }
                        <td>@(leader != null ? leader.Student.StudentName : "No Leader")</td>


                        <td>
                            @(project.ProjectSubmittedDate.HasValue ? project.ProjectSubmittedDate.Value.ToString("yyyy-MM-dd") : "Not submitted")
                        </td>
                        <td>
                            <span class="status-badge status-@project.Status.ToLower()">@project.Status</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                @if (project.Status != "Approved")
                                {
                                    <button class="btn-icon approve"
                                            onclick="confirmApprove(@project.Project_pkId, '@Html.Raw(project.ProjectName.Replace("'", "\\'"))', '@Html.Raw(project.CreatedBy?.Replace("'", "\\'") ?? "")')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                }
                                @if (project.Status != "Rejected")
                                {
                                    <button class="btn-icon reject"
                                            onclick="confirmReject(@project.Project_pkId, '@Html.Raw(project.ProjectName.Replace("'", "\\'"))', '@Html.Raw(project.CreatedBy?.Replace("'", "\\'") ?? "")')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                }
                                <a href="@Url.Action("Details", "ProjectApproval", new { id = project.Project_pkId })" class="btn-icon view">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <div class="pagination-container">
            <ul class="pagination">
                @if (ViewBag.PageNumber > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = ViewBag.CurrentFilter, searchString = ViewBag.SearchString, pageNumber = ViewBag.PageNumber - 1 })">
                            &laquo;
                        </a>
                    </li>
                }

                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(i == ViewBag.PageNumber ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = ViewBag.CurrentFilter, searchString = ViewBag.SearchString, pageNumber = i })">
                            @i
                        </a>
                    </li>
                }

                @if (ViewBag.PageNumber < ViewBag.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new { statusFilter = ViewBag.CurrentFilter, searchString = ViewBag.SearchString, pageNumber = ViewBag.PageNumber + 1 })">
                            &raquo;
                        </a>
                    </li>
                }
            </ul>
        </div>
    }
</div>

@Html.AntiForgeryToken()

@section Scripts {
    <script>
        // Function to handle project approval
        function confirmApprove(projectId, projectName, createdBy) {
            Swal.fire({
                title: 'Approve Project',
                html: `<p>Project: <strong>${projectName}</strong></p>
                       <p>Submitted by: <strong>${createdBy}</strong></p>
                       <p>Are you sure you want to approve this project?</p>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#C8C6C1',
                background: '#E4EEFD',
                confirmButtonText: 'Yes, approve it!',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'custom-swal-popup',
                    title: 'custom-swal-title',
                    content: 'custom-swal-content',
                    confirmButton: 'custom-swal-confirm-btn',
                    cancelButton: 'custom-swal-cancel-btn'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    submitApprove(projectId);
                }
            });
        }

        // Function to handle project rejection
        function confirmReject(projectId, projectName, createdBy) {
            Swal.fire({
                title: 'Reject Project',
                html: `<p>Project: <strong>${projectName}</strong></p>
                       <p>Submitted by: <strong>${createdBy}</strong></p>
                       <textarea id="swal-reject-reason" class="swal2-textarea" placeholder="Please provide a reason for rejection..." required></textarea>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#C8C6C1',
                background: '#E4EEFD',
                confirmButtonText: 'Yes, reject it',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'custom-swal-popup',
                    title: 'custom-swal-title',
                    content: 'custom-swal-content',
                    confirmButton: 'custom-swal-confirm-btn',
                    cancelButton: 'custom-swal-cancel-btn'
                },
                preConfirm: () => {
                    const reason = document.getElementById('swal-reject-reason').value;
                    if (!reason.trim()) {
                        Swal.showValidationMessage('Please enter a rejection reason.');
                        return false;
                    }
                    return reason;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    submitReject(projectId, result.value);
                }
            });
        }

        // Function to submit approval
        function submitApprove(projectId) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('@Url.Action("Approve", "ProjectApproval")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(projectId)
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire("Success!", "Project approved.", "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("Error", data.message || "Failed to approve.", "error");
                }
            })
            .catch(error => {
                Swal.fire("Error", "Request failed: " + error.message, "error");
            });
        }

        // Reject function
        function submitReject(projectId, reason) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('@Url.Action("Reject", "ProjectApproval")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ Id: projectId, Reason: reason })
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire("Success!", "Project rejected.", "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("Error", data.message || "Failed to reject.", "error");
                }
            })
            .catch(error => {
                Swal.fire("Error", "Request failed: " + error.message, "error");
            });
        }

        // Set active filter button on page load
        document.addEventListener('DOMContentLoaded', function() {
            const currentFilter = '@ViewBag.CurrentFilter';
            const filterButtons = document.querySelectorAll('.filter-btn');

            filterButtons.forEach(button => {
                if (button.getAttribute('data-filter') === currentFilter) {
                    button.classList.add('active');
                }
            });
        });
    </script>
}

Detail

@model Project
@{
    ViewData["Title"] = "Project Details";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";
    bool isPending = ViewBag.IsPending ?? false;
    string statusMessage = ViewBag.StatusMessage;
    bool? isSuccess = ViewBag.IsSuccess;
}

<head></head>

<style>
    /* Main container */
    .project-details-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 25px;
        background: #E4EEFD;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Status banner */
    .status-banner {
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        color: white;
    }

    .status-approved {
        background-color: #28a745;
    }

    .status-rejected {
        background-color: #dc3545;
    }

    .status-pending {
        background-color: #ffc107;
        color: #333;
    }

    /* Status message */
    .status-message {
        background-color: #8C5DD1;
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Project header */
    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #C8C6C1;
    }

    .project-title {
        color: #8C5DD1;
        font-size: 1.8rem;
        font-weight: 600;
        margin: 0;
    }

    .project-meta {
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Details sections */
    .details-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        color: #8C5DD1;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid #E4EEFD;
    }

    /* Detail rows */
    .detail-row {
        display: flex;
        margin-bottom: 12px;
    }

    .detail-label {
        font-weight: 600;
        color: #495057;
        min-width: 150px;
    }

    .detail-value {
        color: #212529;
        flex: 1;
    }

    /* Files list */
    .files-list {
        list-style: none;
        padding: 0;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f1f1;
    }

    .file-icon {
        color: #8C5DD1;
        margin-right: 10px;
        font-size: 1.2rem;
    }

    /* Members list */
    .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }

    .member-card {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #8C5DD1;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 25px;
        justify-content: center;
    }

    .btn-approve {
        background-color: #8C5DD1;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-approve:hover {
        background-color: #7a4bbf;
        transform: translateY(-2px);
    }

    .btn-reject {
        background-color: #C8C6C1;
        color: #333;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-reject:hover {
        background-color: #b5b3ae;
        transform: translateY(-2px);
    }

    /* Rejection reason */
    .rejection-reason {
        background: #f8d7da;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #dc3545;
        margin-top: 20px;
    }

    .reason-label {
        font-weight: 600;
        color: #721c24;
        margin-bottom: 8px;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .project-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .detail-row {
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            min-width: auto;
        }
    }

    .back-to-list {
        margin-top: 30px;
        text-align: center;
    }

    .btn-back {
        background-color: #8C5DD1;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

        .btn-back:hover {
            background-color: #7a4bbf;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            color: white;
            text-decoration: none;
        }
</style>

<div class="project-details-container">
    <!-- Status Banner -->
    <div class="status-banner status-@Model.Status.ToLower()">
        @if (Model.Status == "Approved")
        {
            <span>Project Approved on @Model.ApprovedDate?.ToString("MMMM dd, yyyy")</span>
        }
        else if (Model.Status == "Rejected")
        {
            <span>Project Rejected on @Model.RejectedDate?.ToString("MMMM dd, yyyy")</span>
        }
        else
        {
            <span>Project Pending Approval</span>
        }
    </div>

    <!-- Status Message (if any) -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message">
            <i class="fas @(isSuccess == true ? "fa-check-circle" : "fa-exclamation-circle")"></i>
            <span>@statusMessage</span>
        </div>
    }

    <!-- Project Header -->
    <div class="project-header">
        <div>
            <h1 class="project-title">@Model.ProjectName</h1>
            <div class="project-meta">
                Created by @Model.CreatedBy on @Model.CreatedDate.??ToString("MMMM dd, yyyy") |
                Submitted on @Model.ProjectSubmittedDate?.ToString("MMMM dd, yyyy")
            </div>
        </div>
    </div>

    <!-- Basic Information Section -->
    <div class="details-section">
        <h3 class="section-title">Basic Information</h3>

        <div class="detail-row">
            <div class="detail-label">Project Type:</div>
            <div class="detail-value">@Model.ProjectType?.TypeName</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Company:</div>
            <div class="detail-value">@Model.Company?.CompanyName</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Language:</div>
            <div class="detail-value">@Model.Language?.LanguageName</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Framework:</div>
            <div class="detail-value">@Model.Framework?.FrameworkName</div>
        </div>

        <div class="detail-row">
            <div class="detail-label">Supervisor:</div>
            <div class="detail-value">@Model.SupervisorName</div>
        </div>

        <!-- Leader Detail -->
        <div class="detail-row">
            <div class="detail-label">Leader:</div>
            <div class="detail-value">
                @{
                    var leader = Model.ProjectMembers?.FirstOrDefault(pm => pm.Role == "Leader");
                }

                @if (leader != null && leader.Student != null)
                {
                    @leader.Student.StudentName
                }
                else
                {
                    <span>No Leader assigned</span>
                }
            </div>
        </div>

        <!-- Members Detail -->
        <div class="detail-row">
            <div class="detail-label">Members:</div>
            <div class="detail-value">
                @if (Model.ProjectMembers != null)
                {
                    var members = Model.ProjectMembers
                    .Where(pm => pm.Role == "Member" && pm.Student != null)
                    .ToList();

                    if (members.Any())
                    {
                        <ul class="mb-0" style="padding-left: 18px;">
                            @foreach (var member in members)
                            {
                                <li>@member.Student.StudentName</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span>No members assigned</span>
                    }
                }
                else
                {
                    <span>No members assigned</span>
                }
            </div>
        </div>


    </div>

    <!-- Description Section -->
    <div class="details-section">
        <h3 class="section-title">Description</h3>
        <div class="detail-value">@Model.Description</div>
    </div>

    <!-- Files Section -->
    @if (Model.Files != null && Model.Files.Any())
    {
        <div class="details-section">
            <h3 class="section-title">Attached Files</h3>
            <ul class="files-list">
                @foreach (var file in Model.Files)
                {
                    <li class="file-item">
                        <i class="fas fa-file-alt file-icon"></i>
                        <a href="@Url.Action("Download", "Files", new { id = file.ProjectFile_pkId })" target="_blank">
                            @file.FilePath
                        </a>
                    </li>
                }
            </ul>
        </div>
    }

    <!-- Members Section -->
    @if (Model.ProjectMembers != null && Model.ProjectMembers.Any())
    {
        <div class="details-section">
            <h3 class="section-title">Team Members</h3>
            <div class="members-grid">
                @foreach (var member in Model.ProjectMembers)
                {
                    <div class="member-card">
                       <div><strong>@member.Student?.StudentName</strong></div>  <!-- Access through Student navigation property -->
                        <div>@member.Role</div>
                        <div>@member.Student?.Email</div> <!-- If you need email -->
                    </div>
                }
            </div>
        </div>
    }

    <!-- Rejection Reason (if rejected) -->
    @if (Model.Status == "Rejected" && !string.IsNullOrEmpty(Model.AdminComment))
    {
        <div class="rejection-reason">
            <div class="reason-label">Rejection Reason:</div>
            <div>@Model.AdminComment</div>
        </div>
    }

    <!-- Approval Buttons (if pending) -->
    @if (isPending)
    {
        <div class="action-buttons">
            <button type="button" class="btn-approve" onclick="confirmApprove(@Model.Project_pkId, '@Html.Raw(Model.ProjectName.Replace("'", "\\'"))')">
                <i class="fas fa-check"></i> Approve Project
            </button>
            <button type="button" class="btn-reject" onclick="confirmReject(@Model.Project_pkId, '@Html.Raw(Model.ProjectName.Replace("'", "\\'"))')">
                <i class="fas fa-times"></i> Reject Project
            </button>
        </div>
    }
    <!-- Back to List Button -->
    <div class="back-to-list">
        <a href="@Url.Action("Index", "ProjectApproval")" class="btn-back">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

@section Scripts {
    @* <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> *@
    <script>
        function confirmApprove(projectId, projectName) {
            Swal.fire({
                title: 'Approve Project',
                html: `Are you sure you want to approve <strong>${projectName}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#C8C6C1',
                background: '#E4EEFD',
                confirmButtonText: 'Yes, Approve',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'custom-swal-popup',
                    title: 'custom-swal-title',
                    content: 'custom-swal-content',
                    confirmButton: 'custom-swal-confirm-btn',
                    cancelButton: 'custom-swal-cancel-btn'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Approve", "ProjectApproval")',
                        type: 'POST',
                        data: JSON.stringify(projectId),
                        contentType: 'application/json',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                Swal.fire('Error', response.message || 'Failed to approve', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        }
                    });
                }
            });
        }

        function confirmReject(projectId, projectName) {
            Swal.fire({
                title: 'Reject Project',
                html: `
                    <p>Please provide a reason for rejecting <strong>${projectName}</strong></p>
                    <textarea id="swal-reject-reason" class="swal2-textarea" placeholder="Enter rejection reason..." required></textarea>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#8C5DD1',
                cancelButtonColor: '#C8C6C1',
                background: '#E4EEFD',
                confirmButtonText: 'Confirm Rejection',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'custom-swal-popup',
                    title: 'custom-swal-title',
                    content: 'custom-swal-content',
                    confirmButton: 'custom-swal-confirm-btn',
                    cancelButton: 'custom-swal-cancel-btn'
                },
                preConfirm: () => {
                    const reason = document.getElementById('swal-reject-reason').value;
                    if (!reason.trim()) {
                        Swal.showValidationMessage('Please enter a rejection reason');
                        return false;
                    }
                    return { id: projectId, reason: reason };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("Reject", "ProjectApproval")',
                        type: 'POST',
                        data: JSON.stringify(result.value),
                        contentType: 'application/json',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                Swal.fire('Error', response.message || 'Failed to reject', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        }
                    });
                }
            });
        }
    </script>
}